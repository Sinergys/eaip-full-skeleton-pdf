<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EAIP ¬∑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</title>
    <style>
        :root {
            color-scheme: light;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            padding: 32px 16px 48px;
        }
        .container {
            width: min(1040px, 100%);
            margin: 0 auto;
        }
        header {
            margin-bottom: 24px;
        }
        h1 {
            margin: 0;
            font-size: 28px;
            color: #111827;
        }
        .meta-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 18px 20px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            line-height: 1.6;
        }
        .meta-card strong {
            color: #111827;
        }
        .meta-card .status-badge {
            margin-left: 4px;
        }
        .meta-label {
            font-weight: 600;
            color: #374151;
        }
        .meta-value {
            color: #4b5563;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-success {
            background: #dcfce7;
            color: #166534;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 12px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        .checklist {
            margin: 16px 0;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .checklist-item:last-child {
            border-bottom: none;
        }
        .checklist-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 16px;
        }
        .checklist-item-content {
            flex: 1;
        }
        .checklist-item-name {
            font-weight: 600;
            color: #111827;
        }
        .checklist-item-description {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }
        .checklist-item-status {
            font-size: 12px;
            color: #6b7280;
        }
        .warnings {
            margin-top: 16px;
            padding: 12px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
        }
        .warnings.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        .warnings.success h4 {
            color: #065f46;
        }
        .warnings.success ul {
            color: #047857;
        }
        .warnings h4 {
            margin: 0 0 8px;
            color: #92400e;
            font-size: 14px;
        }
        .warnings ul {
            margin: 0;
            padding-left: 20px;
            color: #78350f;
        }
        .warnings li {
            margin: 4px 0;
        }
        .readiness-card {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .readiness-card.not-ready {
            background: #fef2f2;
            border-color: #ef4444;
        }
        .card {
            margin-top: 24px;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            padding: 20px;
        }
        .card h2 {
            margin: 0 0 12px;
            font-size: 20px;
            color: #1f2937;
        }
        .card pre {
            background: #111827;
            color: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            font-size: 13px;
            max-height: 320px;
        }
        textarea {
            width: 100%;
            min-height: 280px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            padding: 14px;
            font-family: "Fira Code", "Courier New", monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        button.primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        button.secondary {
            background: #e5e7eb;
            color: #111827;
        }
        button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 20px rgba(79, 70, 229, 0.18);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .status-message {
            margin-top: 12px;
            font-size: 13px;
            color: #4b5563;
        }
        .alert {
            margin-top: 24px;
            padding: 16px;
            border-radius: 12px;
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —á–µ–∫-–ª–∏—Å—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ */
        .detailed-readiness-checklist {
            margin-top: 24px;
        }
        .readiness-summary {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 16px;
        }
        .readiness-summary h5 {
            margin: 0 0 12px;
            font-size: 16px;
            color: #111827;
        }
        .readiness-summary .progress {
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
        }
        .readiness-summary .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        .badge-success {
            background: #dcfce7;
            color: #166534;
        }
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        .sheet-validation-section {
            margin-top: 24px;
        }
        .sheet-validation-section h4 {
            margin: 0 0 16px;
            font-size: 18px;
            color: #111827;
        }
        .sheet-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: #ffffff;
            transition: border-color 0.2s ease;
        }
        .sheet-card.border-success {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .sheet-card.border-warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        .sheet-card .card-title {
            margin: 0 0 8px;
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }
        .sheet-card .card-text {
            margin: 0 0 12px;
            font-size: 13px;
            color: #6b7280;
        }
        .sheet-card .errors {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        .sheet-card .errors strong {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #991b1b;
        }
        .sheet-card .errors ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: disc;
        }
        .sheet-card .errors li {
            margin: 4px 0;
            font-size: 12px;
            color: #991b1b;
        }
        .text-success {
            color: #166534;
        }
        .text-warning {
            color: #92400e;
        }
        .text-danger {
            color: #991b1b;
        }
        .text-muted {
            color: #6b7280;
        }
        .missing-data-section {
            margin-top: 24px;
        }
        .missing-data-section h4 {
            margin: 0 0 12px;
            font-size: 18px;
            color: #111827;
        }
        .missing-data-section .alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
        }
        .missing-data-section .alert ul {
            margin: 0;
            padding-left: 20px;
            color: #92400e;
        }
        .missing-data-section .alert li {
            margin: 4px 0;
        }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            margin: 0 0 16px;
            font-size: 20px;
            color: #111827;
        }
        .modal-content p {
            margin: 8px 0;
            color: #4b5563;
        }
        .modal-content button {
            margin-top: 16px;
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-content button:hover {
            background: #4f46e5;
        }
        @media (max-width: 720px) {
            body {
                padding: 16px 12px 32px;
            }
            .meta-row {
                flex-direction: column;
                align-items: flex-start;
            }
            button {
                width: 100%;
            }
            .sheet-card {
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</h1>
            <p id="description" style="color:#4b5563;margin-top:8px;"></p>
        </header>

        <section class="meta-card" id="metaGrid">
            <div id="metaSummary">‚Äî</div>
        </section>

        <section class="card" id="readinessCard" style="display:none;">
            <h2>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞</h2>
            <div id="readinessContent">
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="readinessProgress" style="width: 0%;">0%</div>
                </div>
                <div id="readinessStatus" style="margin-top: 12px; font-weight: 600;"></div>
                <div id="checklistContainer" class="checklist"></div>
                <div id="warningsContainer" class="warnings" style="display:none;"></div>
                
                <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ -->
                <div id="detailedReadinessContainer" class="detailed-readiness-checklist" style="display:none;"></div>
            </div>
        </section>

        <section class="card">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h2>
            <p class="status-message">
                –ù–∏–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –í–Ω–µ—Å–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
            </p>
            <textarea id="editableArea" spellcheck="false" placeholder="–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã..."></textarea>
            <div class="actions">
                <button class="primary" id="saveButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button class="secondary" id="reloadButton">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <div style="margin-bottom: 10px;">
                    <label for="templateSelect" style="display: block; margin-bottom: 5px; font-weight: 600;">–í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞:</label>
                    <select id="templateSelect" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-width: 400px;">
                        <option value="new_energy_passport">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω (new_energy_passport)</option>
                        <option value="metin">–®–∞–±–ª–æ–Ω METIN (metin)</option>
                        <option value="default">–®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (default)</option>
                    </select>
                </div>
                <button class="success" id="generatePassportButton">üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç (Excel)</button>
                <button class="success" id="generateWordReportButton" style="background: #2563eb; margin-left: 8px;">üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Word –æ—Ç—á–µ—Ç</button>
                <a class="secondary" href="/web/upload" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–≥—Ä—É–∑–∫–µ</a>
            </div>
            <div id="saveStatus" class="status-message"></div>
            <div id="passportStatus" class="status-message"></div>
            <div id="wordReportStatus" class="status-message"></div>
        </section>

        <section class="card" id="rawDataCard" style="display:none;">
            <h2>–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</h2>
            <pre id="rawJson">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
        </section>

        <div class="actions" style="margin-top:16px;">
            <button class="secondary" id="toggleRawButton">–ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div id="missingMessage" class="alert" style="display:none;">
            –ù–µ —É–∫–∞–∑–∞–Ω batchId. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const batchId = params.get("batchId");

        const batchIdValue = document.getElementById("batchIdValue");
        const enterpriseValue = document.getElementById("enterpriseValue");
        const fileValue = document.getElementById("fileValue");
        const resourceValue = document.getElementById("resourceValue");
        const statusBadge = document.getElementById("statusBadge");
        const description = document.getElementById("description");
        const metaSummary = document.getElementById("metaSummary");
        const editableArea = document.getElementById("editableArea");
        const saveButton = document.getElementById("saveButton");
        const reloadButton = document.getElementById("reloadButton");
        const generatePassportButton = document.getElementById("generatePassportButton");
        const generateWordReportButton = document.getElementById("generateWordReportButton");
        const saveStatus = document.getElementById("saveStatus");
        const passportStatus = document.getElementById("passportStatus");
        const wordReportStatus = document.getElementById("wordReportStatus");
        const rawJson = document.getElementById("rawJson");
        const rawDataCard = document.getElementById("rawDataCard");
        const toggleRawButton = document.getElementById("toggleRawButton");
        const missingMessage = document.getElementById("missingMessage");
        const readinessCard = document.getElementById("readinessCard");
        const readinessProgress = document.getElementById("readinessProgress");
        const readinessStatus = document.getElementById("readinessStatus");
        const checklistContainer = document.getElementById("checklistContainer");
        const warningsContainer = document.getElementById("warningsContainer");
        const detailedReadinessContainer = document.getElementById("detailedReadinessContainer");

        function fmtBytes(bytes) {
            if (!Number.isFinite(bytes)) return "‚Äî";
            if (bytes < 1024) return `${bytes} B`;
            const units = ["KB", "MB", "GB"];
            let i = -1;
            do {
                bytes /= 1024;
                ++i;
            } while (bytes >= 1024 && i < units.length - 1);
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        function setStatusBadge(status) {
            if (!statusBadge) return;
            const normalized = (status || "").toLowerCase();
            statusBadge.textContent = normalized || "unknown";
            statusBadge.className = "status-badge";
            if (normalized === "success") {
                statusBadge.classList.add("status-success");
            } else if (normalized === "error") {
                statusBadge.classList.add("status-error");
            } else {
                statusBadge.classList.add("status-pending");
            }
        }

        function renderSummary(summary, metaRecord) {
            const parts = [];
            const resourceLabel = metaRecord?.parsing_summary?.resource_type_label;
            if (resourceLabel) {
                parts.push(`<strong>–†–µ—Å—É—Ä—Å:</strong> ${resourceLabel}`);
            }
            parts.push(`<strong>Batch ID:</strong> ${batchId}`);
            const enterpriseName = metaRecord?.enterprise_name || "‚Äî";
            parts.push(`<strong>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ:</strong> ${enterpriseName}`);
            parts.push(`<strong>–§–∞–π–ª:</strong> ${metaRecord?.filename || "‚Äî"} (${fmtBytes(metaRecord?.file_size || 0)})`);
            const statusText = (metaRecord?.status || "pending").toLowerCase();
            const badgeClass = statusText === "success" ? "status-badge status-success" : statusText === "error" ? "status-badge status-error" : "status-badge status-pending";
            parts.push(`<strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="${badgeClass}">${statusText}</span>`);

            const dataBlocks = [];
            if (metaRecord?.parsing_summary) {
                dataBlocks.push(metaRecord.parsing_summary);
            }
            if (summary) {
                dataBlocks.push(summary);
            }

            dataBlocks.forEach((block) => {
                Object.entries(block).forEach(([key, value]) => {
                    if (value === null || typeof value === "undefined") {
                        return;
                    }
                    if (key === "batch_id" || key === "status" || key === "parsed" || key === "resource_type" || key === "resource_type_label") {
                        return;
                    }
                    const formattedValue = typeof value === "object"
                        ? JSON.stringify(value)
                        : typeof value === "number" && key.toLowerCase().includes("size")
                            ? fmtBytes(value)
                            : String(value);
                    parts.push(`<strong>${key}:</strong> ${formattedValue}`);
                });
            });

            if (metaSummary) {
                metaSummary.innerHTML = parts.join(" ¬∑ ");
            }
        }

        async function fetchJSON(url, options) {
            const response = await fetch(url, options);
            if (!response.ok) {
                const text = await response.text();
                try {
                    const data = JSON.parse(text);
                    throw new Error(data.detail || text);
                } catch (_) {
                    throw new Error(text);
                }
            }
            return response.json();
        }

        let metaRecordCache = null;

        async function loadMetadata() {
            const record = await fetchJSON(`/api/uploads/${encodeURIComponent(batchId)}`);
            metaRecordCache = record;
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (batchIdValue) batchIdValue.textContent = batchId;
            const enterpriseName = record.enterprise_name || "‚Äî";
            if (enterpriseValue) enterpriseValue.textContent = enterpriseName;
            const fileInfo = `${record.filename || "‚Äî"} ¬∑ ${record.file_type || "unknown"} ¬∑ ${fmtBytes(record.file_size)}`;
            if (fileValue) fileValue.textContent = fileInfo;
            const resourceLabel = record.parsing_summary?.resource_type_label || "‚Äî";
            if (resourceValue) resourceValue.textContent = resourceLabel;
            if (statusBadge) setStatusBadge(record.status);
            if (description) description.textContent = `–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω ${new Date(record.created_at).toLocaleString()} –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è ¬´${enterpriseName}¬ª.`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –µ—Å—Ç—å enterprise_id
            if (record.enterprise_id) {
                await loadReadiness(record.enterprise_id);
            }
        }

        async function loadReadiness(enterpriseId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ–∫-–ª–∏—Å—Ç –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
                const [checklistData, readinessData] = await Promise.all([
                    fetchJSON(`/api/enterprises/${enterpriseId}/upload-checklist`).catch(() => null),
                    fetchJSON(`/api/enterprises/${enterpriseId}/generation-readiness`).catch(() => null)
                ]);

                if (readinessCard) readinessCard.style.display = "block";

                if (readinessData && readinessProgress && readinessStatus) {
                    const progress = readinessData.progress_percentage || 0;
                    const ready = readinessData.ready || false;
                    
                    readinessProgress.style.width = `${progress}%`;
                    readinessProgress.textContent = `${progress}%`;
                    
                    if (ready) {
                        readinessStatus.textContent = `‚úÖ –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (${progress}%)`;
                        readinessStatus.style.color = "#166534";
                        if (generatePassportButton) generatePassportButton.disabled = false;
                    } else {
                        readinessStatus.textContent = `‚è≥ –î–∞–Ω–Ω—ã–µ –Ω–µ –≥–æ—Ç–æ–≤—ã –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (${progress}%)`;
                        readinessStatus.style.color = "#92400e";
                        if (generatePassportButton) generatePassportButton.disabled = true;
                    }
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —á–µ–∫-–ª–∏—Å—Ç
                if (checklistData && checklistContainer) {
                    renderChecklist(checklistData);
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                if (readinessData && readinessData.warnings && warningsContainer) {
                    renderWarnings(readinessData.warnings);
                }

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                if (readinessData && detailedReadinessContainer) {
                    renderDetailedReadiness(readinessData);
                }
            } catch (error) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:", error);
                if (readinessCard) readinessCard.style.display = "none";
            }
        }

        function renderChecklist(checklistData) {
            if (!checklistContainer) return;

            const required = checklistData.required_files || [];
            const optional = checklistData.optional_files || [];

            let html = "";

            if (required.length > 0) {
                html += "<h3 style='margin: 16px 0 8px; font-size: 16px; color: #111827;'>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:</h3>";
                required.forEach(file => {
                    const icon = file.uploaded ? "‚úÖ" : "‚ùå";
                    const statusText = file.uploaded ? "–ó–∞–≥—Ä—É–∂–µ–Ω" : "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
                    const statusColor = file.uploaded ? "#166534" : "#991b1b";
                    
                    html += `
                        <div class="checklist-item">
                            <div class="checklist-item-icon">${icon}</div>
                            <div class="checklist-item-content">
                                <div class="checklist-item-name">${file.description || file.resource}</div>
                                <div class="checklist-item-description">${file.file_patterns.join(", ")}</div>
                            </div>
                            <div class="checklist-item-status" style="color: ${statusColor}">${statusText}</div>
                        </div>
                    `;
                });
            }

            if (optional.length > 0) {
                html += "<h3 style='margin: 24px 0 8px; font-size: 16px; color: #111827;'>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:</h3>";
                optional.forEach(file => {
                    const icon = file.uploaded ? "‚úÖ" : "‚ö™";
                    const statusText = file.uploaded ? "–ó–∞–≥—Ä—É–∂–µ–Ω" : "–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è";
                    const statusColor = file.uploaded ? "#166534" : "#6b7280";
                    
                    html += `
                        <div class="checklist-item">
                            <div class="checklist-item-icon">${icon}</div>
                            <div class="checklist-item-content">
                                <div class="checklist-item-name">${file.description || file.resource}</div>
                                <div class="checklist-item-description">${file.file_patterns.join(", ")}</div>
                            </div>
                            <div class="checklist-item-status" style="color: ${statusColor}">${statusText}</div>
                        </div>
                    `;
                });
            }

            checklistContainer.innerHTML = html;
        }

        function renderWarnings(warnings) {
            if (!warningsContainer || !warnings || warnings.length === 0) {
                if (warningsContainer) warningsContainer.style.display = "none";
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—Å–µ –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            const allLoaded = warnings.length === 1 && 
                             warnings[0].toLowerCase().includes("–≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å success, –µ—Å–ª–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            const successClass = allLoaded ? " success" : "";
            
            warningsContainer.style.display = "block";
            warningsContainer.className = "warnings" + successClass;
            warningsContainer.innerHTML = `
                <h4>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h4>
                <ul>
                    ${warnings.map(w => `<li>${w}</li>`).join("")}
                </ul>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —á–µ–∫-–ª–∏—Å—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        function renderDetailedReadiness(readiness) {
            if (!detailedReadinessContainer || !readiness) {
                return;
            }

            const progress = readiness.progress_percentage || 0;
            const ready = readiness.ready || false;
            const sheetValidation = readiness.sheet_validation || {};
            const missingSheetData = readiness.missing_sheet_data || [];

            let html = `
                <div class="readiness-summary">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <h5>–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</h5>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progress}%">${progress}%</div>
                            </div>
                        </div>
                        <div class="status-badge ${ready ? 'badge-success' : 'badge-warning'}">
                            ${ready ? '‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' : '‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ'}
                        </div>
                    </div>
                </div>
            `;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –ª–∏—Å—Ç–∞–º
            const sheetEntries = Object.entries(sheetValidation);
            if (sheetEntries.length > 0) {
                html += `
                    <div class="sheet-validation-section">
                        <h4>üìä –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏—Å—Ç–æ–≤ –ø–∞—Å–ø–æ—Ä—Ç–∞</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                            ${sheetEntries.map(([sheetName, validation]) => {
                                const isValid = validation.valid !== false;
                                const errors = validation.errors || [];
                                const description = validation.description || '';
                                
                                return `
                                    <div class="sheet-card ${isValid ? 'border-success' : 'border-warning'}">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <h6 class="card-title">${sheetName}</h6>
                                            <span class="${isValid ? 'text-success' : 'text-warning'}" style="font-size: 18px;">
                                                ${isValid ? '‚úÖ' : '‚ö†Ô∏è'}
                                            </span>
                                        </div>
                                        <p class="card-text">
                                            <small class="text-muted">${description}</small>
                                        </p>
                                        ${!isValid && errors.length > 0 ? `
                                            <div class="errors">
                                                <strong>–û—à–∏–±–∫–∏:</strong>
                                                <ul>
                                                    ${errors.map(error => `<li class="text-danger">${error}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            if (missingSheetData.length > 0) {
                html += `
                    <div class="missing-data-section">
                        <h4>‚ùå –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h4>
                        <div class="alert">
                            <ul>
                                ${missingSheetData.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            detailedReadinessContainer.innerHTML = html;
            detailedReadinessContainer.style.display = "block";
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX)
        async function checkReadinessBeforeGeneration(enterpriseId) {
            try {
                const response = await fetch(`/api/enterprises/${enterpriseId}/generation-readiness`);
                if (!response.ok) {
                    // –ï—Å–ª–∏ endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å (fallback –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É)
                    console.warn('–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
                    return true;
                }
                const readiness = await response.json();
                
                if (!readiness.ready) {
                    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏
                    showReadinessWarning(readiness);
                    return false;
                }
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ (—Å–µ—Ä–≤–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç)
                return true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        function showReadinessWarning(readiness) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –≥–æ—Ç–æ–≤—ã –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
                    <p><strong>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:</strong> ${readiness.progress_percentage || 0}%</p>
                    ${readiness.missing_resources && readiness.missing_resources.length > 0 ? 
                        `<p><strong>–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã:</strong> ${readiness.missing_resources.join(', ')}</p>` : ''}
                    ${readiness.missing_files && readiness.missing_files.length > 0 ? 
                        `<p><strong>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã:</strong> ${readiness.missing_files.join(', ')}</p>` : ''}
                    ${readiness.warnings && readiness.warnings.length > 0 ? 
                        `<div class="warnings" style="margin-top: 16px;">
                            <strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</strong>
                            <ul>${readiness.warnings.map(w => `<li>${w}</li>`).join('')}</ul>
                        </div>` : ''}
                    <button onclick="this.closest('.modal').remove()">–ü–æ–Ω—è—Ç–Ω–æ</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function loadSummary() {
            try {
                const summary = await fetchJSON(`/ingest/parse/${encodeURIComponent(batchId)}/summary`);
                renderSummary(summary, metaRecordCache);
            } catch (error) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É", error);
                if (metaSummary) {
                    metaSummary.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                }
            }
        }

        async function loadEditable() {
            if (!editableArea) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç editableArea –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }
            try {
                const data = await fetchJSON(`/api/uploads/${encodeURIComponent(batchId)}/editable`);
                editableArea.value = data.editable_text || "";
                if (saveStatus) {
                    saveStatus.textContent = data.updated_at ? `–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ${new Date(data.updated_at).toLocaleString()}` : ""; 
                }
            } catch (error) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç", error);
                editableArea.value = "";
                if (saveStatus) {
                    saveStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç."; 
                }
            }
        }

        let rawDataLoaded = false;
        let rawDataVisible = false;

        async function loadRawJson() {
            if (rawDataLoaded) return;
            if (!rawJson) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç rawJson –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }
            try {
                const data = await fetchJSON(`/ingest/parse/${encodeURIComponent(batchId)}`);
                rawJson.textContent = JSON.stringify(data, null, 2);
                rawDataLoaded = true;
            } catch (error) {
                rawJson.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        async function saveEditable() {
            if (!saveButton || !editableArea) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç—ã saveButton –∏–ª–∏ editableArea –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                return;
            }
            saveButton.disabled = true;
            if (saveStatus) saveStatus.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."; 
            try {
                await fetchJSON(`/api/uploads/${encodeURIComponent(batchId)}/editable`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: editableArea.value }),
                });
                if (saveStatus) saveStatus.textContent = "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"; 
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", error);
                if (saveStatus) saveStatus.textContent = `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`; 
            } finally {
                saveButton.disabled = false;
            }
        }

        async function reloadAll() {
            const metadata = await loadMetadata();
            await Promise.all([loadSummary(), loadEditable()]);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å enterprise_id
            if (metaRecordCache && metaRecordCache.enterprise_id) {
                await loadReadiness(metaRecordCache.enterprise_id);
            }
        }

        if (saveButton) {
            saveButton.addEventListener("click", async () => {
                await saveEditable();
                await loadEditable();
            });
        }

        if (reloadButton) {
            reloadButton.addEventListener("click", reloadAll);
        }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç–∞
        if (generatePassportButton) {
            generatePassportButton.addEventListener("click", async () => {
                if (!batchId) {
                    if (passportStatus) {
                        passportStatus.textContent = "‚ùå –û—à–∏–±–∫–∞: batch_id –Ω–µ –Ω–∞–π–¥–µ–Ω";
                        passportStatus.style.color = "#991b1b";
                    }
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX)
                if (metaRecordCache && metaRecordCache.enterprise_id) {
                    const isReady = await checkReadinessBeforeGeneration(metaRecordCache.enterprise_id);
                    if (!isReady) {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                        return;
                    }
                }

                generatePassportButton.disabled = true;
                if (passportStatus) {
                    passportStatus.textContent = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç–∞...";
                    passportStatus.style.color = "#92400e";
                }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
                const templateSelect = document.getElementById("templateSelect");
                const templateName = templateSelect ? templateSelect.value : "new_energy_passport";
                
                const response = await fetch(`/api/generate-passport/${batchId}?template_name=${encodeURIComponent(templateName)}`, {
                    method: "POST"
                });

                if (!response.ok) {
                    let errorMessage = `–û—à–∏–±–∫–∞ ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            if (typeof errorData.detail === "object" && errorData.detail.message) {
                                errorMessage = errorData.detail.message;
                                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö
                                if (errorData.detail.missing_resources) {
                                    errorMessage += `\n\n–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–µ—Å—É—Ä—Å—ã: ${errorData.detail.missing_resources.join(", ")}`;
                                }
                                if (errorData.detail.missing_files) {
                                    errorMessage += `\n\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã: ${errorData.detail.missing_files.join(", ")}`;
                                }
                            } else {
                                errorMessage = errorData.detail;
                            }
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `energy_passport_${batchId.substring(0, 8)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                if (passportStatus) {
                    passportStatus.textContent = `‚úÖ –≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!`;
                    passportStatus.style.color = "#166534";
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞:", error);
                if (passportStatus) {
                    passportStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    passportStatus.style.color = "#991b1b";
                }
            } finally {
                generatePassportButton.disabled = false;
            }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Word –æ—Ç—á–µ—Ç–∞
        if (generateWordReportButton) {
            generateWordReportButton.addEventListener("click", async () => {
                if (!batchId) {
                    if (wordReportStatus) {
                        wordReportStatus.textContent = "‚ùå –û—à–∏–±–∫–∞: batch_id –Ω–µ –Ω–∞–π–¥–µ–Ω";
                        wordReportStatus.style.color = "#991b1b";
                    }
                    return;
                }

                generateWordReportButton.disabled = true;
                if (wordReportStatus) {
                    wordReportStatus.textContent = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Word –æ—Ç—á–µ—Ç–∞...";
                    wordReportStatus.style.color = "#92400e";
                }

                try {
                    const response = await fetch(`/api/generate-word-report/${batchId}`, {
                        method: "POST"
                    });

                    if (!response.ok) {
                        let errorMessage = `–û—à–∏–±–∫–∞ ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.detail) {
                                if (typeof errorData.detail === "object" && errorData.detail.message) {
                                    errorMessage = errorData.detail.message;
                                    if (errorData.detail.missing_resources) {
                                        errorMessage += `\n\n–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–µ—Å—É—Ä—Å—ã: ${errorData.detail.missing_resources.join(", ")}`;
                                    }
                                } else {
                                    errorMessage = errorData.detail;
                                }
                            }
                        } catch (e) {
                            const errorText = await response.text();
                            errorMessage = errorText || errorMessage;
                        }
                        throw new Error(errorMessage);
                    }

                    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `energy_report_${batchId.substring(0, 8)}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    if (wordReportStatus) {
                        wordReportStatus.textContent = `‚úÖ Word –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!`;
                        wordReportStatus.style.color = "#166534";
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Word –æ—Ç—á–µ—Ç–∞:", error);
                    if (wordReportStatus) {
                        wordReportStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                        wordReportStatus.style.color = "#991b1b";
                    }
                } finally {
                    generateWordReportButton.disabled = false;
                }
            });
        }

        if (toggleRawButton) {
            toggleRawButton.addEventListener("click", async () => {
            rawDataVisible = !rawDataVisible;
            if (rawDataVisible) {
                toggleRawButton.textContent = "–°–∫—Ä—ã—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ";
                rawDataCard.style.display = "block";
                await loadRawJson();
            } else {
                toggleRawButton.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ";
                if (rawDataCard) rawDataCard.style.display = "none";
            }
            });
        }

        if (!batchId) {
            document.querySelectorAll("section, header").forEach((el) => (el.style.display = "none")); 
            if (missingMessage) missingMessage.style.display = "block";
        } else {
            reloadAll().catch((error) => {
                console.error(error);
                if (missingMessage) {
                    missingMessage.style.display = "block";
                    missingMessage.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}`; 
                }
            });
        }
    </script>
</body>
</html>

