<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EAIP ¬∑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</title>
    <style>
        :root {
            color-scheme: light;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 32px 16px;
        }
        .container {
            background: #ffffff;
            width: min(960px, 100%);
            border-radius: 18px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.22);
            padding: 32px;
        }
        h1 {
            margin: 0 0 8px;
            font-size: 28px;
            color: #1f2937;
        }
        p {
            margin: 0 0 24px;
            color: #4b5563;
        }
        form {
            display: grid;
            gap: 18px;
        }
        label {
            font-weight: 600;
            color: #374151;
        }
        select,
        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-size: 15px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        select:focus,
        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 20px rgba(79, 70, 229, 0.25);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .status {
            margin-top: 16px;
            padding: 14px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }
        .status.success {
            display: block;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        .status.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .progress-container {
            margin-top: 16px;
            padding: 20px;
            border-radius: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            display: none;
        }
        .progress-container.active {
            display: block;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .progress-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }
        .progress-percent {
            font-weight: 700;
            color: #6366f1;
            font-size: 18px;
        }
        .progress-bar-wrapper {
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-message {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .progress-stages {
            display: grid;
            gap: 8px;
            margin-top: 12px;
        }
        .progress-stage {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4b5563;
        }
        .progress-stage-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }
        .progress-stage-icon.pending {
            background: #e5e7eb;
            color: #9ca3af;
        }
        .progress-stage-icon.active {
            background: #6366f1;
            color: white;
        }
        .progress-stage-icon.completed {
            background: #10b981;
            color: white;
        }
        .progress-stage-icon.error {
            background: #ef4444;
            color: white;
        }
        .history-card {
            margin-top: 32px;
            padding: 24px;
            border-radius: 14px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .history-card h2 {
            margin: 0 0 12px;
            font-size: 20px;
            color: #1f2937;
        }
        .history-card p {
            margin-bottom: 16px;
        }
        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 12px;
        }
        .history-item {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .history-item span {
            font-size: 13px;
            color: #4b5563;
        }
        .history-item a {
            font-size: 13px;
            text-decoration: none;
            color: #4f46e5;
            font-weight: 600;
        }
        .hint {
            font-size: 13px;
            color: #6b7280;
        }
        @media (max-width: 720px) {
            .container {
                padding: 20px;
            }
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª (XLSX, XLSM, DOCX, PDF –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ.</p>

        <form id="uploadForm" method="post" enctype="multipart/form-data" onsubmit="return false;">
            <div class="enterprise-field">
                <label for="enterpriseInput">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</label>
                <input
                    type="text"
                    id="enterpriseInput"
                    name="enterprise"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–û–û –°–∏–Ω–µ—Ä–≥–∏—Å"
                    list="enterpriseSuggestions"
                    autocomplete="organization"
                    required
                />
                <datalist id="enterpriseSuggestions"></datalist>
                <p class="hint">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ.</p>
            </div>

            <div>
                <label for="resourceType">–í–∏–¥ —ç–Ω–µ—Ä–≥–æ—Ä–µ—Å—É—Ä—Å–∞ (–¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)</label>
                <select id="resourceType" name="resource_type">
                    <option value="">‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî</option>
                    <option value="electricity">–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</option>
                    <option value="gas">–ì–∞–∑</option>
                    <option value="heat">–¢–µ–ø–ª–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è</option>
                    <option value="water">–í–æ–¥–∞</option>
                    <option value="fuel">–¢–æ–ø–ª–∏–≤–æ –∏ –ì–°–ú</option>
                    <option value="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                    <option value="envelope">–†–∞—Å—á–µ—Ç —Ç–µ–ø–ª–æ–ø–æ—Ç–µ—Ä—å –ø–æ –∑–¥–∞–Ω–∏—è–º</option>
                    <option value="nodes">–£–∑–ª—ã —É—á–µ—Ç–∞</option>
                    <option value="other">–ü—Ä–æ—á–µ–µ</option>
                </select>
                <p class="hint">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É. –ü—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π —Ç–∏–ø.</p>
            </div>

            <div>
                <label for="systemMode">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã</label>
                <select id="systemMode" name="system_mode">
                    <option value="production">üöÄ –†–∞–±–æ—Ç–∞ (–ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)</option>
                    <option value="debug" selected>üîß –û—Ç–ª–∞–¥–∫–∞ (–≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å)</option>
                </select>
                <p class="hint">–í —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã —Ñ–∞–π–ª—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.</p>
            </div>

            <div>
                <label for="fileInput">–§–∞–π–ª—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</label>
                <input
                    type="file"
                    id="fileInput"
                    name="file"
                    accept=".xlsx,.xlsm,.docx,.pdf,.jpg,.jpeg,.png"
                    multiple
                    required
                />
                <div id="selectedFilesList" style="margin-top: 12px; display: none;">
                    <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</div>
                    <ul id="selectedFiles" style="list-style: none; padding: 0; margin: 0; display: grid; gap: 8px;"></ul>
                </div>
            </div>

            <div class="actions">
                <button type="button" id="submitButton">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
                <span class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: XLSX, XLSM (Excel —Å –º–∞–∫—Ä–æ—Å–∞–º–∏), DOCX, PDF, JPG, PNG. –†–∞–∑–º–µ—Ä –¥–æ 50 –ú–ë –∫–∞–∂–¥—ã–π. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤.</span>
            </div>
        </form>

        <div id="status" class="status"></div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-header">
                <div class="progress-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞</div>
                <div class="progress-percent" id="progressPercent">0%</div>
            </div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-message" id="progressMessage">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            <div class="progress-stages" id="progressStages"></div>
            <div style="margin-top: 12px; text-align: center;">
                <button id="cancelButton" type="button" style="background: #dc3545; display: none;">–û—Ç–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
            </div>
        </div>

        <div class="history-card">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h2>
            <p class="hint">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å 20 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º.</p>
            <ul id="historyList" class="history-list"></ul>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö Promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.warn('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ Promise:', event.reason);
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–≤–æ–¥ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞
            if (event.reason && typeof event.reason === 'string' && 
                event.reason.includes('message channel closed')) {
                event.preventDefault();
                return;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.addEventListener('error', function(event) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞
            if (event.message && event.message.includes('message channel closed')) {
                event.preventDefault();
                return false;
            }
        }, true);

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...");
            
            const enterpriseInput = document.getElementById("enterpriseInput");
            const enterpriseSuggestions = document.getElementById("enterpriseSuggestions");
            const fileInput = document.getElementById("fileInput");
            const resourceTypeSelect = document.getElementById("resourceType");
            const statusBox = document.getElementById("status");
            const submitButton = document.getElementById("submitButton");
            const uploadForm = document.getElementById("uploadForm");
            const historyList = document.getElementById("historyList");
            const cancelButton = document.getElementById("cancelButton");
            const selectedFilesList = document.getElementById("selectedFilesList");
            const selectedFiles = document.getElementById("selectedFiles");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            if (!uploadForm || !submitButton || !fileInput || !enterpriseInput) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:", {
                    uploadForm: !!uploadForm,
                    submitButton: !!submitButton,
                    fileInput: !!fileInput,
                    enterpriseInput: !!enterpriseInput
                });
                return;
            }
            
            console.log("–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
            
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        let currentBatchId = null;
        let progressInterval = null;
        let uploadTasks = []; // –ú–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ)
        function updateProgress(data) {
            const progressContainer = document.getElementById("progressContainer");
            const progressBar = document.getElementById("progressBar");
            const progressPercent = document.getElementById("progressPercent");
            const progressMessage = document.getElementById("progressMessage");
            const progressStages = document.getElementById("progressStages");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
            if (!progressBar || !progressPercent || !progressMessage || !progressStages) {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã");
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ DOM
            if (!progressBar.isConnected || !progressPercent.isConnected || 
                !progressMessage.isConnected || !progressStages.isConnected) {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ —É–¥–∞–ª–µ–Ω—ã –∏–∑ DOM");
                return;
            }
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
                const overallProgress = Math.min(100, Math.max(0, data.overall_progress || 0));
                progressBar.style.width = `${overallProgress}%`;
                if (progressPercent) {
                    progressPercent.textContent = `${overallProgress}%`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const currentStage = data.current_stage;
                if (progressMessage) {
                    if (currentStage && data.stages && data.stages[currentStage]) {
                        const stageData = data.stages[currentStage];
                        progressMessage.textContent = stageData.message || `–≠—Ç–∞–ø: ${currentStage}`;
                    } else if (data.has_error) {
                        progressMessage.textContent = `–û—à–∏–±–∫–∞: ${data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`;
                    } else {
                        progressMessage.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...";
                    }
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞:", e);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø—ã
            try {
                if (!progressStages || !progressStages.isConnected) {
                    return; // –≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω –∏–∑ DOM
                }
                
                const stageNames = {
                    upload: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞",
                    validation: "–í–∞–ª–∏–¥–∞—Ü–∏—è",
                    parsing: "–ü–∞—Ä—Å–∏–Ω–≥",
                    ocr: "OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ",
                    ai_analysis: "–ê–Ω–∞–ª–∏–∑ –ò–ò",
                    specialized_parsing: "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥",
                    aggregation: "–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö",
                    saving: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ",
                    completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ",
                    error: "–û—à–∏–±–∫–∞"
                };
                
                progressStages.innerHTML = "";
                const stages = Object.keys(data.stages || {});
                if (stages.length === 0) {
                    // –ï—Å–ª–∏ —ç—Ç–∞–ø–æ–≤ –µ—â–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (progressMessage && progressMessage.isConnected) {
                        progressMessage.textContent = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...";
                    }
                    return;
                }
                
                stages.forEach(stageKey => {
                    const stage = data.stages[stageKey];
                    if (!stage || !progressStages || !progressStages.isConnected) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —ç—Ç–∞–ø—ã
                    
                    try {
                        const stageDiv = document.createElement("div");
                        stageDiv.className = "progress-stage";
                        
                        const icon = document.createElement("div");
                        icon.className = "progress-stage-icon";
                        
                        let iconClass = "pending";
                        let iconText = "‚óã";
                        
                        if (stageKey === currentStage && !data.is_completed) {
                            iconClass = "active";
                            iconText = "‚ü≥";
                        } else if (stage.progress === 100) {
                            iconClass = "completed";
                            iconText = "‚úì";
                        } else if (data.has_error && stageKey === "error") {
                            iconClass = "error";
                            iconText = "‚úó";
                        }
                        
                        icon.className = `progress-stage-icon ${iconClass}`;
                        icon.textContent = iconText;
                        
                        const label = document.createElement("span");
                        const stageName = stageNames[stageKey] || stageKey;
                        const stageProgress = stage.progress || 0;
                        label.textContent = `${stageName}: ${stageProgress}%`;
                        
                        stageDiv.appendChild(icon);
                        stageDiv.appendChild(label);
                        progressStages.appendChild(stageDiv);
                    } catch (e) {
                        console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ —ç—Ç–∞–ø–∞ ${stageKey}:`, e);
                    }
                });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞:", e);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–µ—Å—É—Ä—Å–∞ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        function detectResourceType(filename) {
            const name = filename.toLowerCase();
            
            // –≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã - –æ–±—ã—á–Ω–æ "other"
            if (name.includes("energopasport") || name.includes("—ç–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç") ||
                name.includes("–ø–∞—Å–ø–æ—Ä—Ç") || name.includes("passport")) {
                return "other"; // –ì–æ—Ç–æ–≤—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ - —Ç–∏–ø "other"
            }
            
            // Word –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏ –∏ –≥–æ—Ç–æ–≤—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ - –æ–±—ã—á–Ω–æ "other"
            if (name.endsWith(".docx") || name.endsWith(".doc")) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ñ–∞–π–ª –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –æ—Ç—á–µ—Ç–æ–≤
                if (name.includes("–æ—Ç—á–µ—Ç") || name.includes("report") || 
                    name.includes("–∞—É–¥–∏—Ç") || name.includes("audit") ||
                    name.includes("—Ñ–∏–Ω–∞–ª") || name.includes("final")) {
                    return "other"; // –û—Ç—á–µ—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã - —Ç–∏–ø "other"
                }
                // –ï—Å–ª–∏ —ç—Ç–æ Word —Ñ–∞–π–ª, –Ω–æ –Ω–µ –æ—Ç—á–µ—Ç, –ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
                // (–±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ)
                return "other";
            }
            
            // –≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è
            if (name.includes("—ç–ª–µ–∫—Ç—Ä") || name.includes("electricity") || 
                name.includes("—ç–ª ") || name.includes("pererashod") || 
                name.includes("–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ") || name.includes("—ç–Ω–µ—Ä–≥–æ") ||
                name.includes("edenic") || name.includes("–µ–¥–∏–Ω–∏—Ü") ||
                name.includes("kvt") || name.includes("–∫–≤—Ç") || 
                name.includes("–µ–¥–∏–Ω–∏—Ü –Ω–∞") || name.includes("–µ–¥–∏–Ω–∏—Ü—ã") ||
                name.includes("electro") || name.includes("—ç–ª–µ–∫—Ç—Ä–æ") ||
                (name.includes("act") && name.includes("react")) ||
                name.includes("–∞–∫—Ç–∏–≤") || name.includes("—Ä–µ–∞–∫—Ç–∏–≤")) {
                return "electricity";
            }
            // –ì–∞–∑
            if (name.includes("–≥–∞–∑") || name.includes("gaz") || name.includes("gas")) {
                return "gas";
            }
            // –í–æ–¥–∞
            if (name.includes("–≤–æ–¥–∞") || name.includes("voda") || name.includes("water") ||
                name.includes("—Å—É–≤") || name.includes("–≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ")) {
                return "water";
            }
            // –¢–µ–ø–ª–æ
            if (name.includes("–æ—Ç–æ–ø–ª–µ–Ω–∏–µ") || name.includes("otoplenie") || 
                name.includes("—Ç–µ–ø–ª–æ") || name.includes("heat") || 
                name.includes("–∫–æ—Ç–µ–ª") || name.includes("kotel")) {
                return "heat";
            }
            // –¢–æ–ø–ª–∏–≤–æ
            if (name.includes("–º–∞–∑—É—Ç") || name.includes("mazut") || 
                name.includes("—Ç–æ–ø–ª–∏–≤–æ") || name.includes("fuel")) {
                return "fuel";
            }
            // –£–≥–æ–ª—å
            if (name.includes("—É–≥–æ–ª—å") || name.includes("coal") || name.includes("ugol")) {
                return "coal";
            }
            // –ê–∫—Ç—ã –±–∞–ª–∞–Ω—Å–æ–≤ (—Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —É–∑–ª–∞–º —É—á—ë—Ç–∞)
            if (name.includes("—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è") || name.includes("realizatsiya") ||
                name.includes("–∞–∫—Ç –±–∞–ª–∞–Ω—Å") || name.includes("–∞–∫—Ç –±–∞–ª–∞–Ω—Å–∞") ||
                name.includes("–∞–∫—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏") || name.includes("–±–∞–ª–∞–Ω—Å") ||
                name.includes("–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —É—á—ë—Ç") || name.includes("–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —É—á–µ—Ç") ||
                name.includes("—É–∑–µ–ª —É—á—ë—Ç–∞") || name.includes("—É–∑–µ–ª —É—á–µ—Ç–∞") ||
                name.includes("—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω—ç—Å") || name.includes("–Ω—ç—Å —Ä—É–∑")) {
                // –ê–∫—Ç—ã –±–∞–ª–∞–Ω—Å–æ–≤ - —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ —É–∑–ª–∞–º, –Ω–æ —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –æ—Å—Ç–∞–µ—Ç—Å—è "other"
                // –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                return "other"; // –ê–∫—Ç—ã –±–∞–ª–∞–Ω—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            }
            // –£–∑–ª—ã —É—á–µ—Ç–∞
            if (name.includes("—É–∑–ª—ã") || name.includes("uzly") || name.includes("nodes") ||
                name.includes("—Å—á–µ—Ç—á–∏–∫") || name.includes("schetchiki") || 
                name.includes("—Å—á—ë—Ç—á–∏–∫") || name.includes("metering") ||
                name.includes("–ø—Ä–∏–±–æ—Ä")) {
                return "nodes";
            }
            // –†–∞—Å—á–µ—Ç —Ç–µ–ø–ª–æ–ø–æ—Ç–µ—Ä—å –ø–æ –∑–¥–∞–Ω–∏—è–º
            if (name.includes("–æ–≥—Ä–∞–∂–¥–∞—é—â–∏–µ") || name.includes("ograjdayuschie") ||
                name.includes("envelope") || name.includes("–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏") ||
                name.includes("teploprovodnost") || name.includes("—Ç–µ–ø–ª–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å")) {
                return "envelope";
            }
            // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            if (name.includes("–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ") || name.includes("oborudovanie") ||
                name.includes("equipment")) {
                return "equipment";
            }
            
            return null; // –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        fileInput.addEventListener("change", function() {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                selectedFilesList.style.display = "none";
                return;
            }
            
            selectedFilesList.style.display = "block";
            selectedFiles.innerHTML = "";
            
            files.forEach((file, index) => {
                const li = document.createElement("li");
                li.style.cssText = "padding: 8px 12px; border-radius: 8px; background: #f3f4f6; display: flex; justify-content: space-between; align-items: center; gap: 12px;";
                
                const fileInfo = document.createElement("span");
                fileInfo.style.cssText = "font-size: 13px; color: #4b5563; flex: 1;";
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
                const detectedType = detectResourceType(file.name);
                const resourceTypeLabel = detectedType ? 
                    resourceTypeSelect.querySelector(`option[value="${detectedType}"]`)?.textContent || detectedType :
                    "‚ùì –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
                
                fileInfo.textContent = `${index + 1}. ${file.name} (${fileSizeMB} –ú–ë)`;
                
                const typeLabel = document.createElement("span");
                typeLabel.style.cssText = "font-size: 11px; color: #6366f1; font-weight: 600; padding: 2px 8px; border-radius: 4px; background: #e0e7ff;";
                typeLabel.textContent = resourceTypeLabel;
                
                li.appendChild(fileInfo);
                li.appendChild(typeLabel);
                selectedFiles.appendChild(li);
            });
            
            submitButton.textContent = files.length > 1 ? `–ó–∞–≥—Ä—É–∑–∏—Ç—å ${files.length} —Ñ–∞–π–ª–æ–≤` : "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª";
        });

        async function fetchJSON(url, options) {
            try {
                console.log(`[DEBUG] –ó–∞–ø—Ä–æ—Å –∫ ${url}`, options);
                const response = await fetch(url, options);
                console.log(`[DEBUG] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    console.error(`[DEBUG] –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:`, text);
                    let detail = text;
                    try {
                        const data = JSON.parse(text);
                        detail = data.detail || JSON.stringify(data);
                    } catch (_) {
                        /* ignore */
                    }
                    throw new Error(`HTTP ${response.status}: ${detail}`);
                }
                const jsonData = await response.json();
                console.log(`[DEBUG] JSON –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:`, jsonData);
                return jsonData;
            } catch (error) {
                console.error(`[DEBUG] –û—à–∏–±–∫–∞ fetchJSON:`, error);
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    const detailedError = new Error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8001)?\n2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ URL?\n3. –ù–µ—Ç –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ñ–∞–π—Ä–≤–æ–ª–æ–º?');
                    detailedError.originalError = error;
                    throw detailedError;
                }
                throw error;
            }
        }

        async function loadEnterprises() {
            try {
                const data = await fetchJSON("/api/enterprises");
                enterpriseSuggestions.innerHTML = "";
                (data.items || []).forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item.name;
                    option.dataset.id = item.id;
                    enterpriseSuggestions.appendChild(option);
                });
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π", error);
                showStatus(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è: ${error.message}`, false);
            }
        }

        async function loadHistory(enterpriseId) {
            historyList.innerHTML = "";
            if (!enterpriseId) {
                return;
            }
            try {
                const data = await fetchJSON(`/api/enterprises/${enterpriseId}/uploads`);
                const uploads = data.uploads || [];
                if (uploads.length === 0) {
                    const li = document.createElement("li");
                    li.className = "history-item";
                    li.innerHTML = '<span>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.</span>';
                    historyList.appendChild(li);
                    return;
                }
                uploads.forEach((upload) => {
                    const li = document.createElement("li");
                    li.className = "history-item";

                    const infoSpan = document.createElement("span");
                    let infoText = `${upload.filename} ¬∑ ${upload.status} ¬∑ ${new Date(upload.created_at).toLocaleString()}`;
                    const summary = upload.parsing_summary;
                    if (summary && summary.resource_type_label) {
                        infoText = `${summary.resource_type_label} ¬∑ ${infoText}`;
                    }
                    infoSpan.textContent = infoText;

                    const link = document.createElement("a");
                    link.href = `/web/results?batchId=${encodeURIComponent(upload.batch_id)}`;
                    link.textContent = "–û—Ç–∫—Ä—ã—Ç—å";

                    li.appendChild(infoSpan);
                    li.appendChild(link);
                    historyList.appendChild(li);
                });
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é", error);
                showStatus(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ${error.message}`, false);
            }
        }

        function showStatus(message, isSuccess) {
            statusBox.textContent = message;
            statusBox.className = "status " + (isSuccess ? "success" : "error");
        }

        enterpriseInput.addEventListener("change", () => {
            const value = enterpriseInput.value.trim();
            const suggestion = Array.from(enterpriseSuggestions.options).find((opt) => opt.value === value);
            if (suggestion && suggestion.dataset.id) {
                loadHistory(suggestion.dataset.id);
            } else {
                historyList.innerHTML = "";
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–≤—ã–Ω–æ—Å–∏–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
        async function handleUpload() {
            if (submitButton.disabled) {
                console.log("–ö–Ω–æ–ø–∫–∞ —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É");
                return;
            }

            try {
                const enterpriseNameInput = enterpriseInput.value.trim();
                const files = Array.from(fileInput.files);
                const resourceType = resourceTypeSelect.value || "";

                console.log("=== –ù–ê–ß–ê–õ–û –ó–ê–ì–†–£–ó–ö–ò ===", {
                    enterprise: enterpriseNameInput,
                    filesCount: files.length,
                    resourceType: resourceType,
                    files: files.map(f => f.name)
                });

                if (!enterpriseNameInput) {
                    showStatus("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è", false);
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è!");
                    return;
                }
                if (files.length === 0) {
                    showStatus("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏", false);
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!");
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º enterprise_id
                const suggestion = Array.from(enterpriseSuggestions.options).find((opt) => opt.value === enterpriseNameInput);
                const enterpriseId = suggestion && suggestion.dataset.id ? suggestion.dataset.id : null;
                const enterpriseName = enterpriseId ? null : enterpriseNameInput;

                console.log("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:", {
                    enterpriseId: enterpriseId,
                    enterpriseName: enterpriseName,
                    filesCount: files.length
                });

                // –ï—Å–ª–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
                if (files.length === 1) {
                    await uploadSingleFile(files[0], enterpriseId, enterpriseName, resourceType);
                } else {
                    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                    await uploadMultipleFiles(files, enterpriseId, enterpriseName, resourceType);
                }
            } catch (error) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, false);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                submitButton.disabled = false;
                submitButton.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º)
        uploadForm.addEventListener("submit", async function(event) {
            console.log("=== –°–û–ë–´–¢–ò–ï SUBMIT –§–û–†–ú–´ ===");
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            try {
                await handleUpload();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:", error);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, false);
            }
            return false;
        }, false);
        
        async function uploadSingleFile(file, enterpriseId, enterpriseName, resourceType) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —Ñ–∞–π–ª–∞
            let fileResourceType = resourceType || detectResourceType(file.name) || "other";
            
            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: ${file.name}, —Ç–∏–ø: ${fileResourceType}`);
            
            const formData = new FormData();
            formData.append("file", file);
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ enterpriseId –∏–ª–∏ enterpriseName –Ω–µ –ø—É—Å—Ç—ã–µ
            if (enterpriseId) {
                formData.append("enterprise_id", String(enterpriseId));
                console.log(`–î–æ–±–∞–≤–ª–µ–Ω enterprise_id –≤ FormData: ${enterpriseId}`);
            } else if (enterpriseName && enterpriseName.trim()) {
                formData.append("enterprise_name", enterpriseName.trim());
                console.log(`–î–æ–±–∞–≤–ª–µ–Ω enterprise_name –≤ FormData: ${enterpriseName}`);
            } else {
                throw new Error("–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ '–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ'.");
            }
            
            formData.append("resource_type", fileResourceType);
            console.log(`–î–æ–±–∞–≤–ª–µ–Ω resource_type –≤ FormData: ${fileResourceType}`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
            const systemMode = document.getElementById("systemMode").value;
            formData.append("system_mode", systemMode);
            console.log(`–î–æ–±–∞–≤–ª–µ–Ω system_mode –≤ FormData: ${systemMode}`);

            showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${file.name}...`, true);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            const progressContainer = document.getElementById("progressContainer");
            const progressBar = document.getElementById("progressBar");
            const progressPercent = document.getElementById("progressPercent");
            const progressMessage = document.getElementById("progressMessage");
            const progressStages = document.getElementById("progressStages");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (!progressContainer || !progressBar || !progressPercent || !progressMessage || !progressStages) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ DOM");
                showStatus("–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", false);
                submitButton.disabled = false;
                return;
            }
            
            progressContainer.classList.add("active");
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
            if (cancelButton) {
                cancelButton.style.display = "block";
                cancelButton.disabled = false;
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            try {
                await processUpload(formData, file.name);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}: ${error.message}`, false);
                submitButton.disabled = false;
            }
        }
        
        async function uploadMultipleFiles(files, enterpriseId, enterpriseName, resourceType) {
            console.log(`–ù–∞—á–∞–ª–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ${files.length} —Ñ–∞–π–ª–æ–≤`);
            
            try {
                showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${files.length} —Ñ–∞–π–ª–æ–≤...`, true);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                let multiUploadContainer = document.getElementById("multiUploadContainer");
                if (!multiUploadContainer) {
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    multiUploadContainer = document.createElement("div");
                    multiUploadContainer.id = "multiUploadContainer";
                    multiUploadContainer.style.cssText = "margin-top: 24px; padding: 20px; border-radius: 12px; background: #f9fafb; border: 1px solid #e5e7eb;";
                    multiUploadContainer.innerHTML = `
                        <h3 style="margin: 0 0 16px; font-size: 18px; color: #1f2937;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h3>
                        <div id="multiUploadProgress" style="display: grid; gap: 12px;"></div>
                    `;
                    uploadForm.parentNode.insertBefore(multiUploadContainer, uploadForm.nextSibling);
                }
                
                const multiUploadProgress = document.getElementById("multiUploadProgress");
                if (!multiUploadProgress) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞");
                }
                
                multiUploadProgress.innerHTML = "";
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
                const fileProgress = {};
                files.forEach((file, index) => {
                    const fileItem = document.createElement("div");
                    fileItem.style.cssText = "padding: 12px; border-radius: 8px; background: #ffffff; border: 1px solid #e5e7eb;";
                    fileItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px; font-weight: 600; color: #374151;">${index + 1}. ${file.name}</span>
                            <span id="fileStatus_${index}" style="font-size: 12px; color: #6b7280;">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                        </div>
                        <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div id="fileProgress_${index}" style="height: 100%; background: #6366f1; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    `;
                    multiUploadProgress.appendChild(fileItem);
                    
                    fileProgress[index] = {
                        status: document.getElementById(`fileStatus_${index}`),
                        progress: document.getElementById(`fileProgress_${index}`),
                        item: fileItem
                    };
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
                let successCount = 0;
                let errorCount = 0;
                const batchIds = [];
                
                console.log(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É ${files.length} —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ`);
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ${i + 1}/${files.length}: ${file.name}`);
                    
                    fileProgress[i].status.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
                    fileProgress[i].progress.style.width = "10%";
                    
                    try {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
                        let fileResourceType = resourceType || detectResourceType(file.name) || "other";
                        
                        console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è ${file.name}: ${fileResourceType}`);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞
                        fileProgress[i].status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ (${fileResourceType})...`;
                        
                        const formData = new FormData();
                        formData.append("file", file);
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ enterpriseId –∏–ª–∏ enterpriseName –Ω–µ –ø—É—Å—Ç—ã–µ
                        if (enterpriseId) {
                            formData.append("enterprise_id", String(enterpriseId));
                            console.log(`–î–æ–±–∞–≤–ª–µ–Ω enterprise_id –≤ FormData: ${enterpriseId}`);
                        } else if (enterpriseName && enterpriseName.trim()) {
                            formData.append("enterprise_name", enterpriseName.trim());
                            console.log(`–î–æ–±–∞–≤–ª–µ–Ω enterprise_name –≤ FormData: ${enterpriseName}`);
                        } else {
                            throw new Error("–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ '–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ'.");
                        }
                        
                        formData.append("resource_type", fileResourceType);
                        console.log(`–î–æ–±–∞–≤–ª–µ–Ω resource_type –≤ FormData: ${fileResourceType}`);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
                        const systemMode = document.getElementById("systemMode").value;
                        formData.append("system_mode", systemMode);
                        console.log(`–î–æ–±–∞–≤–ª–µ–Ω system_mode –≤ FormData: ${systemMode}`);
                        
                        // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ FormData –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        console.log("FormData —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ñ–∞–π–ª–∞:", file.name);
                        for (let pair of formData.entries()) {
                            console.log(`  ${pair[0]}: ${pair[1]}`);
                        }
                        
                        console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è ${file.name}...`);
                        const response = await fetchJSON("/web/upload", { method: "POST", body: formData });
                        
                        if (response.batch_id) {
                            batchIds.push(response.batch_id);
                            console.log(`–§–∞–π–ª ${file.name} –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ, batch_id: ${response.batch_id}`);
                        }
                        
                        successCount++;
                        fileProgress[i].status.textContent = `‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ (${fileResourceType})`;
                        fileProgress[i].status.style.color = "#10b981";
                        fileProgress[i].progress.style.width = "100%";
                        fileProgress[i].progress.style.background = "#10b981";
                    } catch (error) {
                        errorCount++;
                        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}:`, error);
                        const errorMsg = error.message || String(error);
                        fileProgress[i].status.textContent = `‚úó –û—à–∏–±–∫–∞: ${errorMsg.substring(0, 40)}...`;
                        fileProgress[i].status.style.color = "#ef4444";
                        fileProgress[i].progress.style.width = "100%";
                        fileProgress[i].progress.style.background = "#ef4444";
                        fileProgress[i].item.style.borderColor = "#ef4444";
                    }
                }
                
                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${successCount} —É—Å–ø–µ—à–Ω–æ, ${errorCount} —Å –æ—à–∏–±–∫–∞–º–∏`);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                showStatus(
                    `–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${successCount} —É—Å–ø–µ—à–Ω–æ, ${errorCount} —Å –æ—à–∏–±–∫–∞–º–∏`,
                    errorCount === 0
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const suggestion = Array.from(enterpriseSuggestions.options).find((opt) => opt.value === enterpriseInput.value.trim());
                const finalEnterpriseId = suggestion && suggestion.dataset.id ? suggestion.dataset.id : null;
                if (finalEnterpriseId) {
                    await loadHistory(finalEnterpriseId);
                }
                
                submitButton.disabled = false;
                submitButton.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                if (errorCount === 0) {
                    fileInput.value = "";
                    selectedFilesList.style.display = "none";
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞
                    let nextButton = document.getElementById("nextToGenerationButton");
                    if (!nextButton) {
                        nextButton = document.createElement("button");
                        nextButton.id = "nextToGenerationButton";
                        nextButton.type = "button";
                        nextButton.style.cssText = `
                            margin-top: 20px;
                            padding: 14px 28px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: #ffffff;
                            border: none;
                            border-radius: 10px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                            width: 100%;
                            max-width: 300px;
                        `;
                        nextButton.textContent = "–î–∞–ª–µ–µ ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞";
                        
                        nextButton.addEventListener("mouseenter", function() {
                            this.style.transform = "translateY(-1px)";
                            this.style.boxShadow = "0 12px 20px rgba(16, 185, 129, 0.25)";
                        });
                        
                        nextButton.addEventListener("mouseleave", function() {
                            this.style.transform = "translateY(0)";
                            this.style.boxShadow = "none";
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                        if (multiUploadContainer) {
                            multiUploadContainer.appendChild(nextButton);
                        } else {
                            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã
                            const container = document.createElement("div");
                            container.style.cssText = "margin-top: 24px; text-align: center;";
                            container.appendChild(nextButton);
                            uploadForm.parentNode.insertBefore(container, uploadForm.nextSibling);
                        }
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–∞–ª–µ–µ"
                    nextButton.onclick = function() {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π batchId (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
                        if (batchIds.length > 0) {
                            const lastBatchId = batchIds[batchIds.length - 1];
                            console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å batchId: ${lastBatchId}`);
                            window.location.href = `/web/results?batchId=${encodeURIComponent(lastBatchId)}`;
                        } else {
                            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫ –Ω–∏–∂–µ.");
                        }
                    };
                    
                    nextButton.style.display = "block";
                } else {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
                    const nextButton = document.getElementById("nextToGenerationButton");
                    if (nextButton) {
                        nextButton.style.display = "none";
                    }
                }
            } catch (error) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ:", error);
                showStatus(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, false);
                submitButton.disabled = false;
                submitButton.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";
            }
        }
        
        async function processUpload(formData, fileName) {
            const progressContainer = document.getElementById("progressContainer");
            const progressBar = document.getElementById("progressBar");
            const progressPercent = document.getElementById("progressPercent");
            const progressMessage = document.getElementById("progressMessage");
            const progressStages = document.getElementById("progressStages");
            
            progressContainer.classList.add("active");
            if (cancelButton) {
                cancelButton.style.display = "block";
                cancelButton.disabled = false;
            }
            
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            try {
                const response = await fetchJSON("/web/upload", { method: "POST", body: formData });
                const batchId = response.batch_id;
                currentBatchId = batchId;
                
                if (cancelButton && batchId) {
                    cancelButton.dataset.batchId = batchId;
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
                if (response.duplicate) {
                    if (progressContainer) {
                        progressContainer.classList.add("active");
                    }
                    if (progressBar && progressPercent && progressMessage) {
                        progressBar.style.width = "100%";
                        progressPercent.textContent = "100%";
                        progressMessage.textContent = "–§–∞–π–ª —É–∂–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Ä–∞–Ω–µ–µ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...";
                    }
                    setTimeout(() => {
                        if (progressContainer) {
                            progressContainer.classList.remove("active");
                        }
                        if (cancelButton) {
                            cancelButton.style.display = "none";
                        }
                        window.location.href = `/web/results?batchId=${encodeURIComponent(batchId)}`;
                    }, 1500);
                    return;
                }
                
                await loadEnterprises();
                const enterpriseId = response.enterprise?.id;
                const enterpriseName = response.enterprise?.name || enterpriseInput.value.trim();
                enterpriseInput.value = enterpriseName;
                if (enterpriseId) {
                    await loadHistory(enterpriseId);
                } else {
                    const newSuggestion = Array.from(enterpriseSuggestions.options).find((opt) => opt.value === enterpriseName);
                    if (newSuggestion && newSuggestion.dataset.id) {
                        await loadHistory(newSuggestion.dataset.id);
                    }
                }
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å retry –ª–æ–≥–∏–∫–æ–π
                const MAX_RETRIES = 10; // –ú–∞–∫—Å–∏–º—É–º 10 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
                let consecutiveErrors = 0;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é currentBatchId
                progressInterval = setInterval(async () => {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                        if (!progressContainer || !progressBar || !progressPercent || !progressMessage || !progressStages) {
                            console.warn("–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ DOM, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å");
                            clearInterval(progressInterval);
                            progressInterval = null;
                            return;
                        }
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentBatchId –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π batchId
                        if (!currentBatchId) {
                            console.warn("Batch ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å");
                            clearInterval(progressInterval);
                            progressInterval = null;
                            return;
                        }
                        
                        const progressData = await fetchJSON(`/api/progress/${currentBatchId}`);
                        consecutiveErrors = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                        
                        // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω:", {
                            overall_progress: progressData.overall_progress,
                            current_stage: progressData.current_stage,
                            is_completed: progressData.is_completed,
                            is_cancelled: progressData.is_cancelled
                        });
                        
                        updateProgress(progressData);
                        
                        // –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
                        if (progressData.is_completed || progressData.has_error || progressData.is_cancelled) {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            if (progressContainer) {
                                progressContainer.classList.remove("active");
                            }
                            if (cancelButton) {
                                cancelButton.style.display = "none";
                            }
                            if (progressData.is_cancelled) {
                                showStatus("–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", false);
                            } else if (progressData.has_error) {
                                showStatus(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${progressData.error}`, false);
                            } else {
                                showStatus("–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...", true);
                                setTimeout(() => {
                                    window.location.href = `/web/results?batchId=${encodeURIComponent(currentBatchId)}`;
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        consecutiveErrors++;
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–ø–æ–ø—ã—Ç–∫–∞ ${consecutiveErrors}):`, error);
                        
                        // –ï—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
                        if (consecutiveErrors >= MAX_RETRIES) {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            if (progressContainer) {
                                progressContainer.classList.remove("active");
                            }
                            if (cancelButton) {
                                cancelButton.style.display = "none";
                            }
                            showStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∑–∂–µ.", false);
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                            setTimeout(() => {
                                if (currentBatchId) {
                                    window.location.href = `/web/results?batchId=${encodeURIComponent(currentBatchId)}`;
                                }
                            }, 3000);
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ 3 –æ—à–∏–±–æ–∫
                            if (consecutiveErrors === 3 && progressMessage) {
                                try {
                                    progressMessage.textContent = "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –ü—Ä–æ–¥–æ–ª–∂–∞—é –ø–æ–ø—ã—Ç–∫–∏...";
                                } catch (e) {
                                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:", e);
                                }
                            }
                        }
                    }
                }, 1000); // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ", error);
                console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:", {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    originalError: error.originalError
                });
                
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                if (progressContainer) {
                    progressContainer.classList.remove("active");
                }
                if (cancelButton) {
                    cancelButton.style.display = "none";
                }
                currentBatchId = null;
                
                // –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorMessage = `–û—à–∏–±–∫–∞: ${error.message}`;
                if (error.message.includes('Failed to fetch') || error.message.includes('—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è')) {
                    errorMessage = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\n` +
                        `–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n` +
                        `1. –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç 8001)\n` +
                        `2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL\n` +
                        `3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–æ–º\n\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
                } else if (error.message.includes('HTTP 400')) {
                    errorMessage = `‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞: ${error.message}\n\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n` +
                        `- –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .xlsx, .xlsm, .docx, .pdf, .jpg, .png)\n` +
                        `- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 50 –ú–ë)\n` +
                        `- –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞`;
                } else if (error.message.includes('HTTP 500')) {
                    errorMessage = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}\n\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
                }
                
                showStatus(errorMessage, false);
                alert(errorMessage); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã";
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
        if (cancelButton) {
            cancelButton.addEventListener("click", async () => {
                const batchId = cancelButton.dataset.batchId || currentBatchId;
                if (!batchId) {
                    console.warn("Batch ID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–º–µ–Ω—ã");
                    return;
                }
                
                cancelButton.disabled = true;
                cancelButton.textContent = "–û—Ç–º–µ–Ω–∞...";
                
                try {
                    const response = await fetch(`/web/upload/${batchId}/cancel`, {
                        method: "POST"
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.cancelled) {
                            showStatus("–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞", false);
                            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                            if (progressInterval) {
                                clearInterval(progressInterval);
                                progressInterval = null;
                            }
                            const progressContainer = document.getElementById("progressContainer");
                            if (progressContainer) {
                                progressContainer.classList.remove("active");
                            }
                            cancelButton.style.display = "none";
                            currentBatchId = null;
                        }
                    } else {
                        const error = await response.json().catch(() => ({ detail: response.statusText }));
                        showStatus(`–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ${error.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`, false);
                        cancelButton.disabled = false;
                        cancelButton.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É";
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ:", error);
                    showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, false);
                    cancelButton.disabled = false;
                    cancelButton.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É";
                }
            });
        }

        loadEnterprises().then(() => {
            const value = enterpriseInput.value.trim();
            const suggestion = Array.from(enterpriseSuggestions.options).find((opt) => opt.value === value);
            if (suggestion && suggestion.dataset.id) {
                loadHistory(suggestion.dataset.id);
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)
        if (!submitButton) {
            console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: submitButton –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            alert("–û—à–∏–±–∫–∞: –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
            } else {
                console.log("–ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫...");
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                const handleButtonClick = async function(event) {
                    console.log("=== –ö–ù–û–ü–ö–ê –ù–ê–ñ–ê–¢–ê ===");
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    try {
                        await handleUpload();
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", error);
                        showStatus(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, false);
                    }
                };
                
                submitButton.addEventListener("click", handleButtonClick, false);
                console.log("–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            }
        
        console.log("–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–æ–±–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ");
        
        }); // –ö–æ–Ω–µ—Ü DOMContentLoaded
    </script>
</body>
</html>

