# AI Content Classifier

## Описание

`AIContentClassifier` - это модуль для улучшения классификации типов энергоресурсов с помощью искусственного интеллекта. Он использует LLM (Large Language Model) для анализа содержимого файлов и определения типа ресурса на основе структуры данных, а не только имени файла.

## Преимущества

1. **Улучшенная точность**: AI может распознавать альтернативные названия листов (например, "ЭЛЕКТР" vs "Электроэнергия")
2. **Анализ структуры**: AI анализирует структуру данных, единицы измерения и заголовки
3. **Fallback на правила**: Если AI недоступен или не уверен, используется классификация по правилам
4. **Низкая уверенность**: AI используется только когда уверенность >= 0.5

## Использование

### Автоматическая интеграция

Классификатор автоматически интегрирован в `ResourceClassifier.classify()`. Он используется когда:
- Правила не смогли определить тип ресурса
- Уверенность правил низкая

### Ручное использование

```python
from utils.ai_content_classifier import get_ai_content_classifier

# Получить экземпляр классификатора
ai_classifier = get_ai_content_classifier()

if ai_classifier:
    # Классифицировать файл
    resource_type, confidence = ai_classifier.classify_with_ai(
        raw_json=parsed_data,
        filename="pererashod.xlsx"
    )
    
    if resource_type and confidence >= 0.7:
        print(f"Тип ресурса: {resource_type} (уверенность: {confidence:.2f})")
```

## Требования

1. **AI должен быть настроен**:
   - Установлена переменная окружения `AI_ENABLED=true`
   - Установлен API ключ (например, `DEEPSEEK_API_KEY`)
   - Провайдер AI настроен (например, `AI_PROVIDER=deepseek`)

2. **Зависимости**:
   - `ai_parser.py` - для работы с AI API
   - `settings.ai_settings.py` - для получения настроек AI

## Логика работы

1. **Правила (приоритет 1)**: Сначала пробуется классификация по правилам через `content_analyzer.py`
2. **AI (приоритет 2)**: Если правила не определили тип, используется AI
3. **Имя файла (приоритет 3)**: Если AI не доступен или не уверен, используется анализ имени файла
4. **Fallback (приоритет 4)**: Если ничего не помогло, возвращается "other"

## Поддерживаемые типы ресурсов

- `electricity` - Электроэнергия
- `gas` - Газ
- `water` - Вода
- `heat` - Тепловая энергия
- `fuel` - Топливо и ГСМ
- `coal` - Уголь
- `equipment` - Оборудование
- `envelope` - Ограждающие конструкции
- `nodes` - Узлы учета
- `other` - Прочее

## Примеры использования

### Пример 1: Классификация Excel файла

```python
raw_json = {
    "file_type": "excel",
    "parsing": {
        "data": {
            "sheets": [
                {
                    "name": "ЭЛЕКТР",  # Альтернативное название
                    "rows": [
                        ["Месяц", "кВт·ч", "Сумма"],
                        ["Январь", 1000, 50000]
                    ]
                }
            ]
        }
    }
}

# Правила могут не распознать "ЭЛЕКТР", но AI сможет
resource_type = ResourceClassifier.classify("pererashod.xlsx", raw_json)
# Результат: "electricity"
```

### Пример 2: Классификация PDF файла

```python
raw_json = {
    "file_type": "pdf",
    "parsing": {
        "data": {
            "text": "Отчет о потреблении газа за 2024 год. Объем: 5000 м³..."
        }
    }
}

resource_type = ResourceClassifier.classify("report.pdf", raw_json)
# Результат: "gas"
```

## Настройка

### Переменные окружения

```bash
# Включить AI
export AI_ENABLED=true

# Выбрать провайдера
export AI_PROVIDER=deepseek  # или openai, anthropic

# Установить API ключ
export DEEPSEEK_API_KEY=your_api_key_here
```

### Пороги уверенности

- **Высокая уверенность (>= 0.7)**: AI результат используется без вопросов
- **Средняя уверенность (>= 0.5)**: AI результат используется, но логируется предупреждение
- **Низкая уверенность (< 0.5)**: AI результат игнорируется, используется fallback

## Логирование

Классификатор логирует:
- Успешную классификацию с уверенностью
- Ошибки при вызове AI
- Предупреждения при низкой уверенности

Уровни логирования:
- `INFO`: Успешная классификация
- `DEBUG`: Детальная информация о процессе
- `WARNING`: Ошибки или низкая уверенность

## Производительность

- **Время ответа**: ~1-3 секунды на запрос к AI API
- **Кэширование**: Не реализовано (можно добавить через `ai_cache.py`)
- **Ограничения**: AI используется только когда правила не справились

## Обработка ошибок

Классификатор обрабатывает ошибки gracefully:
- Если AI недоступен, используется fallback на правила
- Если AI вернул ошибку, используется fallback на правила
- Если AI вернул невалидный результат, используется fallback на правила

## Будущие улучшения

1. **Кэширование результатов**: Добавить кэширование для уменьшения количества запросов к AI
2. **Батчинг**: Обрабатывать несколько файлов за один запрос
3. **Метрики**: Отслеживать точность классификации AI
4. **Обучение**: Использовать результаты для улучшения промптов

