# Улучшения обработки PDF файлов

## Дата реализации: 2025-01-XX

## Резюме проблем

Система не могла эффективно обрабатывать сканированные PDF-файлы и файлы на основе изображений. Модуль парсинга был полностью зависим от текстовых данных и не имел надежного OCR-конвейера.

## Реализованные улучшения

### ✅ 1. Предварительная классификация типа PDF

**Проблема:** Классификация типа PDF происходила ПОСЛЕ попытки парсинга, что приводило к неэффективной обработке.

**Решение:** Создан модуль `utils/pdf_classifier.py` с функцией `classify_pdf_type()`, которая:
- Определяет тип PDF ДО начала парсинга
- Использует быструю проверку через PyPDF2 (первые 3 страницы)
- При необходимости использует pdfplumber для более точной классификации
- Возвращает метрики: `type`, `confidence`, `text_ratio`

**Типы PDF:**
- `text_based` - текстовый PDF
- `image_based` - PDF на основе изображений (сканированный)
- `hybrid` - смешанный тип
- `unknown` - не удалось определить

### ✅ 2. Улучшенный пайплайн обработки

**Проблема:** OCR запускался только после провала всех парсеров.

**Решение:** Реализованы три стратегии обработки:

1. **`ocr_first`** - для явно сканированных документов
   - Сразу применяется OCR
   - Извлечение таблиц из OCR текста
   - Структурирование данных

2. **`text_first`** - для текстовых PDF
   - Стандартный пайплайн (pdfplumber → PyPDF2)
   - OCR только при необходимости

3. **`hybrid`** - для смешанных типов
   - Комбинированный подход
   - Адаптивная обработка

### ✅ 3. Проверка наличия Java для Tabula

**Проблема:** Tabula не работал из-за отсутствия Java, но система пыталась его использовать.

**Решение:**
- Добавлена функция `check_java_available()` в `utils/table_detector.py`
- Проверка выполняется при импорте модуля
- Tabula используется только если Java доступна
- Логируется предупреждение, если Java не найдена

### ✅ 4. Извлечение таблиц из OCR текста

**Проблема:** После OCR не извлекались структурированные данные (таблицы).

**Решение:** Создан модуль `utils/ocr_table_extractor.py` с функциями:
- `extract_tables_from_ocr_text()` - извлечение таблиц из OCR текста
- Использует эвристики для поиска табличных структур:
  - Поиск выровненных колонок (пробелы/табы)
  - Поиск разделителей (|, ||, ---)
  - Анализ структуры строк
- `structure_ocr_data()` - структурирование данных после OCR

### ✅ 5. Обработка структурированных данных после OCR

**Проблема:** Данные после OCR не структурировались.

**Решение:**
- Автоматическое извлечение таблиц из OCR текста
- Структурирование данных в секции
- Сохранение метаданных о найденных таблицах

## Технические детали

### Новая архитектура обработки PDF

```python
def parse_pdf_file(file_path: str, batch_id: Optional[str] = None) -> Dict[str, Any]:
    # 1. Предварительная классификация типа PDF
    pdf_classification = classify_pdf_type(file_path)
    strategy = get_pdf_processing_strategy(pdf_classification)
    
    # 2. Выбор стратегии обработки
    if strategy == "ocr_first":
        return _process_pdf_with_ocr_first(...)
    else:
        # Стандартный пайплайн
        ...
```

### Модули

1. **`utils/pdf_classifier.py`**
   - `classify_pdf_type()` - классификация типа PDF
   - `get_pdf_processing_strategy()` - выбор стратегии
   - `check_java_available()` - проверка Java

2. **`utils/ocr_table_extractor.py`**
   - `extract_tables_from_ocr_text()` - извлечение таблиц
   - `structure_ocr_data()` - структурирование данных

3. **`utils/table_detector.py`** (обновлен)
   - Проверка Java для Tabula
   - Пропуск Tabula если Java недоступна

## Приоритеты доработки

### P0 (Критические) - ✅ Реализовано
- ✅ Предварительная классификация типа PDF
- ✅ Улучшенный пайплайн обработки
- ✅ Проверка наличия Java для Tabula
- ✅ Извлечение таблиц из OCR текста

### P1 (Важные) - Частично реализовано
- ⚠️ Интеграция scikit-image для улучшения изображений (частично - используется opencv-python)
- ⚠️ Обучение моделей распознавания табличных структур (базовая версия через эвристики)

### P2 (Желательные)
- Кэширование результатов OCR для одинаковых документов
- Параллельная обработка страниц OCR
- Улучшенные эвристики для извлечения таблиц

## Использование

Система автоматически определяет тип PDF и выбирает оптимальную стратегию обработки:

1. **Сканированный PDF** → OCR-first → извлечение таблиц из OCR
2. **Текстовый PDF** → Text-first → стандартный парсинг
3. **Смешанный PDF** → Hybrid → адаптивная обработка

## Результаты

- ✅ Сканированные PDF обрабатываются эффективнее (OCR-first стратегия)
- ✅ Таблицы извлекаются из OCR текста
- ✅ Tabula не вызывает ошибки при отсутствии Java
- ✅ Предварительная классификация ускоряет обработку

## Требования

- Python 3.11+
- PyPDF2 или pdfplumber
- Tesseract OCR (для сканированных документов)
- Poppler (для конвертации PDF в изображения)
- Java (опционально, для Tabula)

## Установка Java (для Tabula)

### Windows
```powershell
# Через chocolatey
choco install openjdk

# Или скачать с https://adoptium.net/
```

### Linux
```bash
sudo apt-get install default-jre
```

### Docker
Добавить в Dockerfile:
```dockerfile
RUN apt-get update && apt-get install -y default-jre && rm -rf /var/lib/apt/lists/*
```

