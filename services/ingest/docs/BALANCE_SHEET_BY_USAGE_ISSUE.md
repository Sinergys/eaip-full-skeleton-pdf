# –ü—Ä–æ–±–ª–µ–º–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ 'electricity.by_usage' –¥–ª—è –ª–∏—Å—Ç–∞ '04_–ë–∞–ª–∞–Ω—Å'

**–î–∞—Ç–∞:** 2025-01-XX  
**–§–∞–π–ª —Å –ø—Ä–æ–±–ª–µ–º–æ–π:** `data/source_files/audit_sinergys/–ù–æ–≤–∞—è –ø–∞–ø–∫–∞/EnergyPassport_PKM690_filled.xlsx`  
**–õ–∏—Å—Ç:** `'04_–ë–∞–ª–∞–Ω—Å'`

---

## üîç –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

–ü—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Å–ø–æ—Ä—Ç–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:

```
–õ–∏—Å—Ç '04_–ë–∞–ª–∞–Ω—Å': –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ 'electricity.by_usage'
```

**–ì–¥–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:** `eaip_full_skeleton/services/ingest/domain/passport_requirements.py`, —Å—Ç—Ä–æ–∫–∞ 600

---

## üìã –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –õ–ò–°–¢–ê '04_–ë–∞–ª–∞–Ω—Å'

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞:

**–§–∞–π–ª:** `EnergyPassport_PKM690_filled.xlsx`  
**–õ–∏—Å—Ç:** `'04_–ë–∞–ª–∞–Ω—Å'`  
**–†–∞–∑–º–µ—Ä:** 4 —Å—Ç—Ä–æ–∫–∏, 5 —Å—Ç–æ–ª–±—Ü–æ–≤

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
1. **–°—Ç—Ä–æ–∫–∞ 1:** –ó–∞–≥–æ–ª–æ–≤–∫–∏ - "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å" | "2022" | "2023" | "2024" | "–ï–¥."
2. **–°—Ç—Ä–æ–∫–∞ 2:** "–û–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (—ç–ª. —ç–Ω–µ—Ä–≥–∏—è –∞–∫—Ç–∏–≤.)" | —Ñ–æ—Ä–º—É–ª—ã SUMIFS
3. **–°—Ç—Ä–æ–∫–∞ 3:** "–û–±—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (—ç–ª. —ç–Ω–µ—Ä–≥–∏—è —Ä–µ–∞–∫—Ç–∏–≤.)" | —Ñ–æ—Ä–º—É–ª—ã SUMIFS
4. **–°—Ç—Ä–æ–∫–∞ 4:** "–ü–æ—Ç–µ—Ä–∏ (–µ—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã)" | —Ñ–æ—Ä–º—É–ª—ã SUMIFS

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ª–∏—Å—Ç–µ **–ù–ï–¢** —Å—Ç—Ä–æ–∫ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω—É–∂–¥—ã
- –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ
- –•–æ–∑-–±—ã—Ç–æ–≤—ã–µ

---

## üîß –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –õ–ò–°–¢–ê

### `fill_balans_sheet()` –≤ `tools/fill_energy_passport.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. **–û—á–∏—â–∞–µ—Ç –≤–µ—Å—å –ª–∏—Å—Ç** (—É–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏)
2. **–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**
   - –°—Ç—Ä–æ–∫–∞ 1: "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è"
   - –°—Ç—Ä–æ–∫–∞ 2: –ó–∞–≥–æ–ª–æ–≤–∫–∏ - "–ö–≤–∞—Ä—Ç–∞–ª", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ", "–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω—É–∂–¥—ã", "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ", "–•–æ–∑-–±—ã—Ç–æ–≤—ã–µ", "–ò—Ç–æ–≥–æ"
   - –°—Ç—Ä–æ–∫–∏ 3+: –î–∞–Ω–Ω—ã–µ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

3. **–ó–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑:** `agg_data["resources"]["electricity"][quarter]["by_usage"]`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `by_usage` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö, —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–¥–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç.

---

## ‚ö†Ô∏è –ü–†–ò–ß–ò–ù–´ –û–¢–°–£–¢–°–¢–í–ò–Ø –î–ê–ù–ù–´–•

### 1. –§–∞–π–ª `pererashod.xlsx` –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É
- –§—É–Ω–∫—Ü–∏—è `aggregate_usage_categories()` –¥–æ–ª–∂–Ω–∞ –Ω–∞–π—Ç–∏ –∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ñ–∞–π–ª
- –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ `usage_categories.json`

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `pererashod.xlsx` –∑–∞–≥—Ä—É–∂–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ `aggregate_usage_categories()` –≤ `utils/energy_aggregator.py`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç 4-—é —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

### 2. –§—É–Ω–∫—Ü–∏—è `distribute_categories_by_quarter()` –Ω–µ –≤—ã–∑–≤–∞–Ω–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í `main.py` (—Å—Ç—Ä–æ–∫–∞ 1276) –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏—è `distribute_categories_by_quarter()`
- –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—å `by_usage` –≤ –∫–∞–∂–¥—ã–π –∫–≤–∞—Ä—Ç–∞–ª `aggregation_data`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `usage_categories` –Ω–µ `None` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `distribute_categories_by_quarter()`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `pererashod.xlsx` –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π

**–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- 4 —Ç–∞–±–ª–∏—Ü—ã, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ 2 –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
- 4-—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Å—Ç—Ä–æ–∫–∏ 26-37)
- –°—Ç—Ä–æ–∫–∞ 26: –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≥–æ–¥–æ–≤
- –°—Ç—Ä–æ–∫–∞ 29: "–¢–µ—Ö-–ø–æ—Ç–µ—Ä–∏ –∫–í—Ç—á"
- –°—Ç—Ä–æ–∫–∞ 30: "–•–æ–∑-–±—ã—Ç–æ–≤—ã–µ –Ω—É–∂–¥—ã –∫–í—Ç—á"
- –°—Ç—Ä–æ–∫–∞ 31: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω—É–∂–¥—ã"

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `analyze_pererashod_structure.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `aggregate_usage_categories()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç 4-—é —Ç–∞–±–ª–∏—Ü—É

### 4. –î–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –§–∞–π–ª `oborudovanie.xlsx` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω
- –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `{batch_id}_equipment.json`
- –§—É–Ω–∫—Ü–∏—è `aggregate_usage_categories()` –¥–æ–ª–∂–Ω–∞ –ø–æ–ª—É—á–∞—Ç—å `equipment_data` –¥–ª—è —Å–≤–µ—Ä–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π `pererashod.xlsx`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `equipment_data_for_categories` –Ω–µ `None` –≤ `main.py` (—Å—Ç—Ä–æ–∫–∞ 1268)

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö

```python
# –í main.py –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ aggregate_usage_categories()
if usage_categories:
    logger.info(f"–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {usage_categories}")
else:
    logger.error("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallback –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º

```python
# –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ distribute_categories_by_quarter()
if aggregation_data:
    electricity = aggregation_data.get("resources", {}).get("electricity", {})
    for quarter, quarter_data in electricity.items():
        by_usage = quarter_data.get("by_usage")
        if not by_usage:
            logger.warning(f"–ö–≤–∞—Ä—Ç–∞–ª {quarter}: by_usage –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è")
```

### –®–∞–≥ 3: Fallback –º–µ—Ö–∞–Ω–∏–∑–º

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ `pererashod.xlsx` –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
1. –î–∞–Ω–Ω—ã–µ –∏–∑ `oborudovanie.xlsx` (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
2. –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
3. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

---

## üìù –ü–†–û–í–ï–†–ö–ê –í–ê–õ–ò–î–ê–¶–ò–ò

**–§–∞–π–ª –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** `domain/passport_requirements.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª–∏—Å—Ç–∞ '04_–ë–∞–ª–∞–Ω—Å':**
```python
"04_–ë–∞–ª–∞–Ω—Å": SheetRequirement(
    critical_fields=[
        FieldRequirement(
            field_name="electricity.by_usage",
            required=True,
            validation_rules={
                "min_quarters": 4,
                "required_categories": ["technological", "own_needs", "production", "household"]
            }
        ),
    ],
)
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –ù–∞–ª–∏—á–∏–µ –ø–æ–ª—è `electricity.by_usage` –≤ –¥–∞–Ω–Ω—ã—Ö
- –ú–∏–Ω–∏–º—É–º 4 –∫–≤–∞—Ä—Ç–∞–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
- –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: `technological`, `own_needs`, `production`, `household`

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –§–ê–ô–õ–´

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** `eaip_full_skeleton/services/ingest/domain/passport_requirements.py`
2. **–ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:** `eaip_full_skeleton/services/ingest/utils/energy_aggregator.py` (—Ñ—É–Ω–∫—Ü–∏—è `aggregate_usage_categories()`)
3. **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º:** `eaip_full_skeleton/services/ingest/utils/energy_aggregator.py` (—Ñ—É–Ω–∫—Ü–∏—è `distribute_categories_by_quarter()`)
4. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–∏—Å—Ç–∞:** `tools/fill_energy_passport.py` (—Ñ—É–Ω–∫—Ü–∏—è `fill_balans_sheet()`)
5. **–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥:** `eaip_full_skeleton/services/ingest/main.py` (—Å—Ç—Ä–æ–∫–∏ 1260-1277)

---

## üìä –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ `aggregated_data`:

```json
{
  "resources": {
    "electricity": {
      "2022-Q1": {
        "year": 2022,
        "quarter": 1,
        "quarter_totals": {
          "active_kwh": 1000000
        },
        "by_usage": {
          "technological": 600000,
          "own_needs": 100000,
          "production": 250000,
          "household": 50000
        }
      },
      "2022-Q2": { ... },
      ...
    }
  }
}
```

---

## –ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

