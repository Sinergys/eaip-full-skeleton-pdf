# AI-Усиленное Распознавание PDF-Сканов

## Обзор

Система теперь использует AI для улучшения качества OCR распознавания PDF-сканов. Это критически важная функция, которая напрямую влияет на качество исходных данных для всего энергоаудита.

## Архитектура

### Модули

1. **`ai_ocr_enhancer.py`** - Улучшение качества OCR через AI
   - Исправляет типичные OCR ошибки (0/O, 1/l/I, 5/S, 8/B)
   - Восстанавливает разрывы слов и строк
   - Улучшает распознавание русских букв
   - Исправляет единицы измерения и числовые значения

2. **`ai_data_validator.py`** - Валидация извлеченных данных
   - Проверяет правдоподобность данных энергопотребления
   - Выявляет аномалии и опечатки
   - Проверяет соответствие единиц измерения
   - Валидирует логические соотношения показателей

3. **`ai_table_parser.py`** - Структурирование таблиц
   - Восстанавливает структуру таблиц после OCR
   - Определяет заголовки столбцов
   - Разделяет числовые и текстовые ячейки
   - Извлекает единицы измерения

## Интеграция в пайплайн

### Пайплайн обработки PDF-сканов:

```
1. OCR (Tesseract)
   ↓
2. AI-Усиление OCR ← НОВОЕ!
   ↓
3. AI-Валидация данных ← НОВОЕ!
   ↓
4. Извлечение таблиц
   ↓
5. AI-Структурирование таблиц ← НОВОЕ!
   ↓
6. Сохранение результатов
```

## Использование

### Настройка

AI-усиление OCR автоматически включается, если:
1. AI провайдер настроен (см. `AI_SETUP.md`)
2. Переменная окружения `AI_ENABLED=true`

```env
AI_ENABLED=true
AI_PROVIDER=deepseek
DEEPSEEK_API_KEY=sk-ваш-ключ
```

### Результаты

После обработки PDF-скана результаты содержат:

```json
{
  "text": "улучшенный текст после AI-усиления",
  "ocr_used": true,
  "ai_validation": {
    "is_valid": true,
    "confidence": 0.95,
    "issues": [],
    "warnings": [],
    "suggestions": []
  },
  "tables": [
    {
      "headers": ["Период", "Потребление", "Единица"],
      "rows": [...],
      "ai_used": true
    }
  ],
  "ai_tables_structured": true
}
```

## Ожидаемые результаты

### Улучшение точности распознавания
- **+30-50%** точности распознавания сканов
- Автоматическое исправление типичных OCR-ошибок
- Валидация данных до сохранения в систему

### Улучшение структурирования
- Восстановление структуры таблиц после OCR
- Корректное определение заголовков и типов данных
- Извлечение единиц измерения

## Логирование

Система логирует все этапы AI-обработки:

```
INFO: OCR завершен: всего извлечено 1234 символов
INFO: Применяю AI-усиление OCR для улучшения качества распознавания...
INFO: AI-усиление OCR завершено: улучшений: 5, уверенность: 0.85
INFO: Применяю AI-валидацию извлеченных данных...
INFO: AI-валидация завершена: валидно: true, проблем: 0, уверенность: 0.95
INFO: Применяю AI-структурирование таблиц...
INFO: AI-структурировано 2 таблиц
```

## Обработка ошибок

Система gracefully обрабатывает ошибки AI:
- Если AI недоступен, используется оригинальный OCR текст
- Ошибки логируются, но не прерывают обработку
- Fallback на стандартные методы при сбоях

## Производительность

- AI-усиление OCR: ~2-5 секунд на документ
- AI-валидация: ~1-3 секунды на документ
- AI-структурирование таблиц: ~2-4 секунды на таблицу

**Рекомендация:** Для больших документов (>10 страниц) обработка может занять больше времени.

## Требования

- AI провайдер настроен (DeepSeek, OpenAI, Anthropic)
- `AI_ENABLED=true` в переменных окружения
- Доступ к AI API (интернет-соединение)

## Отключение AI-усиления

Если нужно отключить AI-усиление OCR:

```env
AI_ENABLED=false
```

Или просто не настраивать AI провайдер - система автоматически использует только стандартный OCR.

