# E2E Тест генерации энергопаспорта

## Описание

Полноценный end-to-end тест полного потока генерации энергопаспорта для audit_sinergys.

Тест выполняет:
1. Загрузку всех необходимых файлов из `data/source_files/audit_sinergys`
2. Создание нового batch через загрузку файлов
3. Проверку readiness для предприятия
4. Генерацию паспорта с шаблоном `new_energy_passport`
5. Проверку структуры, формул и данных в итоговом файле

## Используемые файлы

Тест использует следующие файлы из `data/source_files/audit_sinergys`:

- `pererashod.xlsx` - электроэнергия
- `gaz.xlsx` - газ
- `voda.xlsx` - вода
- `otoplenie.xlsx` - тепло
- `oborudovanie.xlsx` - оборудование
- `schetchiki.xlsx` - узлы учета
- `teploprovodnost.xlsx` - ограждающие конструкции

## Запуск теста

### Предварительные требования

1. Убедитесь, что все тестовые файлы находятся в `data/source_files/audit_sinergys`
2. Убедитесь, что сервис ingest запущен (для использования TestClient)
3. Установите зависимости: `pytest`, `fastapi`, `openpyxl`

### Запуск

```bash
# Из корня проекта
cd eaip_full_skeleton/services/ingest
pytest tests/test_passport_e2e_audit_sinergys.py -v

# Или из корня репозитория
pytest eaip_full_skeleton/services/ingest/tests/test_passport_e2e_audit_sinergys.py -v
```

### Запуск с подробным выводом

```bash
pytest tests/test_passport_e2e_audit_sinergys.py -v -s
```

Флаг `-s` отключает захват вывода, чтобы видеть все print-сообщения.

## Что проверяет тест

### 1. Загрузка файлов
- Все файлы успешно загружаются через `/web/upload`
- Для каждого файла создается новый batch_id
- Парсинг каждого файла завершается успешно

### 2. Проверка readiness
- Вызывается `/api/enterprises/{enterprise_id}/generation-readiness`
- Проверяется, что `overall_status` не равен "blocked"
- Проверяется `completeness_score`

### 3. Генерация паспорта
- Вызывается `/api/generate-passport/{batch_id}` с параметром `template_name=new_energy_passport`
- Получается бинарное содержимое файла
- Файл сохраняется во временный файл

### 4. Проверка структуры
- Проверяется наличие ключевых листов:
  - `Struktura pr2` (или варианты названия)
  - `Balans` (или варианты названия)
  - `Equipment` (или варианты названия)
  - `Nodes` (или варианты названия)

### 5. Проверка формул
- На листе `Balans` проверяется наличие формул
- На листе `Equipment` проверяется наличие формул
- Формулы должны иметь `data_type == 'f'` и не быть пустыми

### 6. Проверка данных
- На листе `Struktura pr2` проверяется заполнение ресурсов:
  - Электроэнергия (активная и реактивная)
  - Газ
  - Вода
  - Тепло (если есть)
- Проверяется, что данные заполнены для всех кварталов (2022-2024)
- На листе `Balans` проверяется наличие данных

## Временный файл

После успешного выполнения теста временный файл паспорта НЕ удаляется, чтобы можно было проверить его вручную.

Путь к файлу выводится в конце теста.

## Обработка ошибок

- Если тестовые файлы не найдены, тест пропускается с сообщением
- Если загрузка файла не удалась, тест падает с описанием ошибки
- Если парсинг не завершился в течение 5 минут, тест падает с таймаутом
- Если readiness blocked, тест падает с описанием проблемы
- Если генерация паспорта не удалась, тест падает с описанием ошибки
- Если структура или формулы не соответствуют ожиданиям, тест падает с описанием

## Логирование

Тест выводит подробную информацию о каждом шаге:
- Какие файлы загружаются
- Какие batch_id получены
- Статус readiness
- Результаты проверки структуры, формул и данных

## Примечания

- Тест создает НОВЫЕ batch_id при каждом запуске
- Тест НЕ использует старые данные из БД
- Тест полностью автоматизирован и не требует участия пользователя
- Тест воспроизводим: каждый запуск создает новый batch и генерирует новый паспорт

