# Реализация требований ТЗ для модуля загрузки файлов

## Дата: 2025-01-XX
## Версия ТЗ: 2.2

## Выполненные требования

### ✅ Раздел 4.1 - Модуль 1: Импорт и обработка данных

#### 1. Загрузка файлов форматов XLSX, DOCX, PDF, JPG, PNG
- ✅ Реализована валидация расширений файлов
- ✅ Реализована проверка MIME-типов
- ✅ Добавлена поддержка всех требуемых форматов

#### 2. Валидация загружаемых данных
- ✅ Проверка типа файла (расширение + MIME)
- ✅ Проверка размера файла (до 50 МБ согласно разделу 4.2)
- ✅ Проверка на пустые файлы

### ✅ Раздел 4.2 - Нефункциональные требования

#### Производительность
- ✅ Ограничение размера файла: 50 МБ (как указано в ТЗ)
- ⏳ Обработка файла до 50 МБ за 30 секунд - требует тестирования

### ✅ Раздел 5.1 - Технологический стек

#### Бэкенд
- ✅ Python 3.10+ (FastAPI)
- ✅ Добавлены библиотеки для работы с файлами:
  - `openpyxl==3.1.2` - для парсинга Excel
  - `pandas==2.2.0` - для обработки данных
  - `python-docx==1.1.0` - для парсинга Word
  - `Pillow==10.2.0` - для работы с изображениями

## Реализованные функции

### 1. Валидация файлов (`validate_file()`)
- Проверка расширения файла
- Проверка MIME-типа
- Возвращает понятные сообщения об ошибках на русском языке

### 2. Проверка размера файла (`validate_file_size()`)
- Проверка до 50 МБ
- Проверка на пустые файлы
- Асинхронная обработка

### 3. Улучшенный веб-интерфейс
- Отображение поддерживаемых форматов
- Указание максимального размера файла
- Клиентская валидация перед отправкой
- Улучшенная обработка ошибок

### 4. Модуль парсинга файлов (`file_parser.py`)
- Базовая структура для парсинга Excel
- Поддержка эталонного шаблона `EnergyPassport_v1.1.2.xlsx`
- Парсинг DOCX файлов
- Заготовки для PDF и изображений (OCR)

## API Endpoints

### `POST /web/upload`
- Принимает файл через веб-интерфейс
- Валидирует тип и размер
- Возвращает batch_id, имя файла, тип и размер

### `POST /ingest/files`
- API endpoint для программной загрузки
- Та же валидация, что и в веб-интерфейсе
- Интеграция с сервисом валидации

## Константы согласно ТЗ

```python
ALLOWED_EXTENSIONS = {'.xlsx', '.docx', '.pdf', '.jpg', '.jpeg', '.png'}
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 МБ
```

## Следующие шаги (не реализовано)

### Требуется доработка:
1. **Автоматическое распознавание шаблона** `EnergyPassport_v1.1.2.xlsx`
   - Нужен сам шаблон для анализа структуры
   - Реализация специфичного парсера

2. **Структурирование данных** из эталонного шаблона
   - Маппинг полей шаблона на структуру БД
   - Валидация данных по типам

3. **OCR для изображений** (JPG, PNG)
   - Интеграция с pytesseract или аналогичными библиотеками

4. **Парсинг PDF**
   - Использование PyPDF2 или pdfplumber
   - Извлечение текста и таблиц

5. **Асинхронная обработка** (Celery)
   - Для файлов > 10 МБ
   - Соответствие требованию обработки за 30 секунд

## Тестирование

Для тестирования:
1. Запустить сервис: `uvicorn main:app --reload --port 8001`
2. Открыть веб-интерфейс: `http://localhost:8001/web/upload`
3. Попробовать загрузить файлы разных форматов
4. Проверить валидацию (неподдерживаемые форматы, превышение размера)

## Соответствие ТЗ

- ✅ Раздел 4.1 - Модуль 1: **Частично реализовано** (загрузка и валидация готовы, парсинг в базовой версии)
- ✅ Раздел 4.2 - Нефункциональные требования: **Частично реализовано** (ограничения размера, производительность требует тестирования)
- ✅ Раздел 5.1 - Технологический стек: **Соответствует** (FastAPI, Python 3.10+)

---

**Статус:** Базовая реализация завершена. Требуется доработка парсинга и интеграция с шаблоном EnergyPassport_v1.1.2.xlsx

