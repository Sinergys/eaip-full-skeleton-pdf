# üìä –°–≤–æ–¥–∫–∞ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ PDF

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (`utils/pdf_diagnostics.py`)

**–§—É–Ω–∫—Ü–∏–∏:**
- `analyze_pdf_structure()` - –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã PDF
- `test_ocr_pipeline()` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OCR –∫–æ–Ω–≤–µ–π–µ—Ä–∞
- `diagnose_pdf()` - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- `print_diagnostic_report()` - –≤—ã–≤–æ–¥ –æ—Ç—á–µ—Ç–∞

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ù–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ª–æ—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ–∫—Å—Ç–æ–º (% —Å—Ç—Ä–∞–Ω–∏—Ü —Å —Ç–µ–∫—Å—Ç–æ–º)
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OCR –±–∏–±–ª–∏–æ—Ç–µ–∫
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö PDF

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É < 50 –ò–õ–ò
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ–∫—Å—Ç–æ–º < 30% —Å—Ç—Ä–∞–Ω–∏—Ü

**–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:**
- `high` - < 10 —Å–∏–º–≤–æ–ª–æ–≤/—Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ < 10% –ø–æ–∫—Ä—ã—Ç–∏–µ
- `medium` - < 50 —Å–∏–º–≤–æ–ª–æ–≤/—Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ < 30% –ø–æ–∫—Ä—ã—Ç–∏–µ
- `low` - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–µ–∫—Å—Ç–∞

### 3. API endpoint –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**Endpoint:** `GET /api/diagnose/pdf`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `file_path` - –ø—É—Ç—å –∫ PDF —Ñ–∞–π–ª—É
- `batch_id` - ID –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:8001/api/diagnose/pdf?batch_id=xxx-xxx-xxx"
```

### 4. –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (`utils/test_pdf_scenarios.py`)

**6 —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF:**
1. –ß–∏—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π PDF
2. –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PDF
3. –ì–∏–±—Ä–∏–¥–Ω—ã–π PDF
4. PDF —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
5. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π PDF
6. –ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PDF

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É

```bash
cd eaip_full_skeleton/services/ingest
python utils/pdf_diagnostics.py "–ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É.pdf"
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ API

```bash
# –ü–æ batch_id
curl "http://localhost:8001/api/diagnose/pdf?batch_id=xxx-xxx-xxx"

# –ü–æ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É
curl "http://localhost:8001/api/diagnose/pdf?file_path=/data/inbox/test.pdf"
```

---

## üìã –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∑–∞–¥–∞–Ω–∏—è

### 1. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã PDF

**‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è PyPDF2 –∏ pdfplumber –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
- pdf2image –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- Pillow –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- Tesseract OCR –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞:**
- –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PDF –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–µ–∫—Å—Ç–∞ –∏ –ø–æ–∫—Ä—ã—Ç–∏—é
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ª–æ—è
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ OCR pipeline

**‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- OCR –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö PDF
- –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–æ–Ω—Ç—Ä–∞—Å—Ç +50%, —Ä–µ–∑–∫–æ—Å—Ç—å +20%)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ OCR

**–≠—Ç–∞–ø—ã:**
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ PDF (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π/—Ç–µ–∫—Å—Ç–æ–≤—ã–π)
2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
3. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
4. OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

**‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–æ–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Ç–µ–∫—Å—Ç/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–∏–±—Ä–∏–¥–Ω—ã—Ö PDF (—Ç–µ–∫—Å—Ç + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)

**–ü–æ—Ä–æ–≥–∏:**
- < 50 —Å–∏–º–≤–æ–ª–æ–≤/—Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Üí —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- < 30% —Å—Ç—Ä–∞–Ω–∏—Ü —Å —Ç–µ–∫—Å—Ç–æ–º ‚Üí —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏

---

## üîß –£–ª—É—á—à–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### `file_parser.py`

**–î–æ:**
```python
avg_chars_per_page = result["total_characters"] / len(pdf.pages)
result["is_scanned"] = avg_chars_per_page < 50
```

**–ü–æ—Å–ª–µ:**
```python
avg_chars_per_page = result["total_characters"] / len(pdf.pages)
pages_with_text = sum(1 for p in result["pages"] if p.get("char_count", 0) > 0)
text_coverage = (pages_with_text / len(pdf.pages) * 100)

is_likely_scanned = avg_chars_per_page < 50 or text_coverage < 30
result["is_scanned"] = is_likely_scanned
result["scanned_confidence"] = "high" if avg_chars_per_page < 10 else "medium"
result["text_coverage"] = text_coverage
```

---

## üìä –ü—Ä–∏–º–µ—Ä –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞

```json
{
  "file": {
    "path": "/data/inbox/test.pdf",
    "size_mb": 2.5,
    "exists": true
  },
  "structure_analysis": {
    "scanned_detection": {
      "avg_chars_per_page": 2.5,
      "is_likely_scanned": true,
      "confidence": "high",
      "text_coverage": 5.0
    }
  },
  "ocr_test": {
    "can_convert": true,
    "can_ocr": true,
    "total_chars_extracted": 1234
  },
  "summary": {
    "pdf_type": "scanned",
    "needs_ocr": true,
    "ready_for_processing": true
  }
}
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:**
   ```bash
   python utils/pdf_diagnostics.py "–ø—É—Ç—å/–∫/–ø—Ä–æ–±–ª–µ–º–Ω–æ–º—É/pdf"
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
   ```bash
   python utils/test_pdf_scenarios.py
   ```

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:**
   ```bash
   curl "http://localhost:8001/api/diagnose/pdf?batch_id=xxx"
   ```

4. **–ò–∑—É—á–∏—Ç–µ –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:**
   - –°–º. `PDF_DIAGNOSTICS_GUIDE.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

