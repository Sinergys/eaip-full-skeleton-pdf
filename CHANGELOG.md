# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]

### Fixed - 2025-11-05

#### PDF Generation with Cyrillic Support

**Issue**: PDF files generated by the reports service did not display Cyrillic characters correctly - they appeared as squares or were missing.

**Solution**:
- Added **DejaVuSans TTF font** with full Cyrillic support (`services/reports/assets/fonts/DejaVuSans.ttf`)
- Updated PDF generation code to use TTF fonts instead of UnicodeCIDFont
- Implemented font family registration for proper bold text rendering
- Added fallback mechanism if bold font variant is not available

**Technical Details**:
- Font registration happens at module import time in `services/reports/main.py`
- All PDF styles (`title_style`, `heading2_style`, `normal_style`) now use `DejaVuSans`
- Tables use Unicode font for all cells
- Font family registered for `<b>` tag support in Paragraph elements

**Files Changed**:
- `services/reports/main.py` - Added TTF font registration and Unicode font support
- `services/reports/assets/fonts/DejaVuSans.ttf` - Added font file
- `services/reports/requirements.txt` - Already includes `reportlab==4.2.5`

#### Startup Stability

**Issue**: The `audit_demo.ps1` script sometimes failed with "connection refused" errors because the reports service container wasn't ready yet.

**Solution**:
- Added port readiness check before generating PDF reports
- Script now waits for port 8005 to be available before making API calls

**Implementation**:
```powershell
Write-Host "Waiting for reports service..."
while (-not (Test-NetConnection -ComputerName 127.0.0.1 -Port 8005 -InformationLevel Quiet)) {
    Start-Sleep -Seconds 1
}
Write-Host "Reports service is ready."
```

**Files Changed**:
- `infra/audit_demo.ps1` - Added startup wait check

### Verification

After these changes:
- ✅ PDF files display Cyrillic text correctly
- ✅ PDF headers are valid (`%PDF-1.x`)
- ✅ Script runs reliably after `docker compose up`
- ✅ Font registration logs visible in container output

### Usage

To generate a PDF with Cyrillic support:

```powershell
cd infra
docker compose build reports
docker compose up -d reports
pwsh -ExecutionPolicy Bypass -File .\audit_demo.ps1
```

The generated PDF file `passport_demo1_full.pdf` will contain correctly rendered Cyrillic text.

