# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

**–î–∞—Ç–∞:** 2025-11-08  
**–í–µ—Ä—Å–∏—è:** v0.3.1  
**–§–∞–π–ª:** `services/ingest/main.py`

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ Excel —Ñ–∞–π–ª–∞ —Å–µ–∫—Ü–∏–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ –ø–æ—è–≤–ª—è–ª–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —Ö–æ—Ç—è —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–∞–ª—Å—è –∏ –ø–∞—Ä—Å–∏–ª—Å—è.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:**
```json
{
  "batch_id": "3549b36a-d31f-4a8d-908b-66eed270d2f3",
  "saved": "3549b36a-d31f-4a8d-908b-66eed270d2f3__2022-2024.xlsx",
  "file_type": "Excel (XLSX)",
  "file_size": 19842,
  "parsing_status": "success",
  "parsing_summary": {
    "sheets": 2,
    "total_rows": 116
  }
}
```

## –ü—Ä–∏—á–∏–Ω—ã

1. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Excel** - —Ñ—É–Ω–∫—Ü–∏—è `displayResults()` –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞ –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–æ–≤
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –≤ `displayEditableData()` –Ω–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç—ã–µ –ª–∏—Å—Ç—ã
3. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ç—Ä—É–¥–Ω–æ –±—ã–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
4. **–°–ª–∞–±—ã–µ CSS –ø—Ä–∞–≤–∏–ª–∞** - —Å–µ–∫—Ü–∏–∏ –º–æ–≥–ª–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å—Ç–∏–ª–µ–π

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –§—É–Ω–∫—Ü–∏—è `displayResults()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–≤—å—é Excel –¥–∞–Ω–Ω—ã—Ö

**–î–æ:**
```javascript
} else if (parsing.file_type === 'excel') {
    html += '<h4>üìä Excel —Ñ–∞–π–ª</h4>';
    html += '<ul>';
    html += '<li><strong>–õ–∏—Å—Ç–æ–≤:</strong> ' + (parsedData.sheets?.length || 0) + '</li>';
    html += '<li><strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</strong> ' + (parsedData.sheets?.reduce((sum, s) => sum + (s.max_row || 0), 0) || 0) + '</li>';
    html += '</ul>';
}
```

**–ü–æ—Å–ª–µ:**
```javascript
} else if (parsing.file_type === 'excel') {
    html += '<h4>üìä Excel —Ñ–∞–π–ª</h4>';
    html += '<ul>';
    const sheets = parsedData.sheets || [];
    html += '<li><strong>–õ–∏—Å—Ç–æ–≤:</strong> ' + sheets.length + '</li>';
    html += '<li><strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</strong> ' + 
        sheets.reduce((sum, s) => sum + (s.max_row || 0), 0) + '</li>';
    html += '</ul>';
    
    // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞
    if (sheets.length > 0 && sheets[0].rows && sheets[0].rows.length > 0) {
        html += '<h4 style="margin-top: 15px;">–ü—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –ª–∏—Å—Ç–∞ "' + escapeHtml(sheets[0].name || 'Sheet1') + '"):</h4>';
        html += '<div class="data-viewer">';
        const previewRows = sheets[0].rows.slice(0, 10);
        previewRows.forEach(row => {
            html += escapeHtml(row.join(' | ')) + '<br>';
        });
        html += '</div>';
    }
}
```

### 2. –§—É–Ω–∫—Ü–∏—è `displayEditableData()` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Excel

**–î–æ:**
```javascript
} else if (parsing.file_type === 'excel') {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Excel –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    parsedData.sheets?.forEach(sheet => {
        textToEdit += '=== –õ–∏—Å—Ç: ' + sheet.name + ' ===\n';
        sheet.rows?.slice(0, 100).forEach(row => {
            textToEdit += row.join('\t') + '\n';
        });
        textToEdit += '\n';
    });
}
```

**–ü–æ—Å–ª–µ:**
```javascript
} else if (parsing.file_type === 'excel') {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Excel –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    const sheets = parsedData.sheets || [];
    sheets.forEach(sheet => {
        textToEdit += '=== –õ–∏—Å—Ç: ' + (sheet.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + ' ===\n';
        if (sheet.rows && sheet.rows.length > 0) {
            sheet.rows.slice(0, 100).forEach(row => {
                textToEdit += row.join('\t') + '\n';
            });
        } else {
            textToEdit += '(–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö)\n';
        }
        textToEdit += '\n';
    });
}
```

### 3. –§—É–Ω–∫—Ü–∏—è `loadParsingResults()` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```javascript
console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', fullData);
console.log('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ parsing:', fullData.parsing);
console.log('parsed:', fullData.parsing?.parsed);
console.log('file_type:', fullData.parsing?.file_type);

const errorText = await response.text();
console.error('HTTP Error:', response.status, errorText);

const sectionResults = document.getElementById('section-results');
if (sectionResults) {
    sectionResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ parsed
if (fullData.parsing && fullData.parsing.parsed === true) {
```

### 4. CSS - —É—Å–∏–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π

**–î–æ:**
```css
.workflow-section {
    display: none;
}
.workflow-section.active {
    display: block;
}
```

**–ü–æ—Å–ª–µ:**
```css
.workflow-section {
    display: none !important;
}
.workflow-section.active {
    display: block !important;
}
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–°–µ–∫—Ü–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤  
‚úÖ **–ü—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö Excel** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤  
‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞** —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞  
‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è  
‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ** —Å–µ–∫—Ü–∏–π –±–ª–∞–≥–æ–¥–∞—Ä—è `!important` –≤ CSS

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8001/web/upload
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `2022-2024.xlsx`)
3. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```
   –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ: {batch_id: "...", ...}
   –ü–æ–∫–∞–∑—ã–≤–∞—é —Å–µ–∫—Ü–∏–∏...
   –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è batch_id: ...
   –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: {...}
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞ parsing: {...}
   parsed: true
   file_type: excel
   –ü–æ–∫–∞–∑—ã–≤–∞—é —Å–µ–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
   –ü–æ–∫–∞–∑–∞–Ω–∞ —Å–µ–∫—Ü–∏—è: section-results
   –ü–æ–∫–∞–∑–∞–Ω–∞ —Å–µ–∫—Ü–∏—è: section-edit
   –ü–æ–∫–∞–∑–∞–Ω–∞ —Å–µ–∫—Ü–∏—è: section-validate
   –ü–æ–∫–∞–∑–∞–Ω–∞ —Å–µ–∫—Ü–∏—è: section-next
   –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ, –æ—Ç–æ–±—Ä–∞–∂–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   ```

5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ 4 —Å–µ–∫—Ü–∏–∏:
   - **–°–µ–∫—Ü–∏—è 1:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (—Å –ø—Ä–µ–≤—å—é –ø–µ—Ä–≤—ã—Ö 10 —Å—Ç—Ä–æ–∫)
   - **–°–µ–∫—Ü–∏—è 2:** –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ —Å–æ –≤—Å–µ–º–∏ –ª–∏—Å—Ç–∞–º–∏)
   - **–°–µ–∫—Ü–∏—è 3:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
   - **–°–µ–∫—Ü–∏—è 4:** –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
curl -X POST http://localhost:8001/web/upload \
  -F "file=@2022-2024.xlsx"

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
curl http://localhost:8001/ingest/parse/{batch_id}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –î–ª—è –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π

1. **–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞** –≤ –ø—Ä–µ–≤—å—é Excel –¥–∞–Ω–Ω—ã—Ö
2. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>100 —Å—Ç—Ä–æ–∫)
3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –ø–æ –ª–∏—Å—Ç–∞–º Excel
4. **–≠–∫—Å–ø–æ—Ä—Ç** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ CSV/JSON
5. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è** —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `services/ingest/main.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- `services/ingest/file_parser.py` - –º–æ–¥—É–ª—å –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel —Ñ–∞–π–ª–æ–≤
- `NEW_SESSION_PROMPT.md` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ü—Ä–µ–≤—å—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 100 —Å—Ç—Ä–æ–∫ –Ω–∞ –ª–∏—Å—Ç
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Excel (—Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç—ã)
- OCR –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò API


